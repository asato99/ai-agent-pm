# 改善提案: タスク自動進行ワークフロー

**提案番号**: 001
**日付**: 2026-01-25
**更新日**: 2026-01-28
**発見経緯**: パイロットテスト実行時

---

## ステータス遷移の責任分担（明確化）

### 核心原則: エージェントは自身のサブタスクの管理責任を持つ

**各エージェントは、自身が作成したサブタスクのステータス管理に責任を持つ。**

| タスクの作成者 | ステータス遷移の責任者 | 操作方法 |
|----------------|------------------------|----------|
| Owner/System（Manager向け） | **Owner** | UI から `in_progress` に更新 |
| Manager（Worker向けサブタスク） | **Manager** | `update_task_status` ツールで `in_progress` に更新 |
| Worker（自身のサブタスク） | **Worker** | `update_task_status` ツールで `in_progress` に更新 |

**原則**:
- Owner は**マネージャーのタスクのみ**を更新する
- Manager は**自身が作成したサブタスク**を更新する責任がある
- Worker は**自身が作成したサブタスク**を更新する責任がある
- タスクが開始されないのは**作成者の判断ミス**（システムの問題ではない）

詳細: `docs/TASK_STATUS_WORKFLOW.md`

---

## 現状の動作

1. オーナーがマネージャーにチャットでタスク依頼を送信
2. マネージャーがタスクを作成
3. タスクは`backlog`状態で作成され、**作成者（マネージャー）に割り当てられる**
4. **オーナーがマネージャーのタスクを`in_progress`に更新**（UI操作）
5. マネージャーがサブタスクを作成・ワーカーに割り当て
6. **マネージャーがサブタスクを`in_progress`に更新すべき**（`update_task_status`ツール）← **ここが問題**

## 問題点

サブタスクを作成したエージェント（Manager または Worker）が `update_task_status` を呼んでいない。
そのため、サブタスクのステータスは `backlog` または `todo` のまま。

Coordinator は `in_progress` のタスクのみを検知してワーカーをスポーンするため、
ワーカーは `no_pending_work` を返し、タスクが処理されない。

**これはシステムの問題ではなく、サブタスク作成者の判断ミス**である。
`get_next_action` のガイダンスまたはエージェントのシステムプロンプトで `update_task_status` の使用を明示的に指示する必要がある。

## 改善案

### 推奨案: request_task + 実行確認フロー

チャットセッションからの`request_task`の戻り値、または`get_next_action`の制御として、依頼報告と同時に**実行開始の確認**を返す。

#### フロー

```
1. オーナー → マネージャー: チャットで依頼
2. マネージャー: タスク作成（backlog状態）
3. マネージャー → オーナー: 「タスクを作成しました。実行を開始してよろしいですか？」
4. オーナー: 承認
5. システム: タスクステータスを todo/in_progress に更新
6. ワーカー: タスクを検知して作業開始
```

#### 実装イメージ

**request_taskの戻り値拡張**:
```json
{
  "task_id": "task-001",
  "status": "backlog",
  "requires_approval": true,
  "approval_prompt": "タスク「hello.pyの作成」を開始してよろしいですか？"
}
```

**get_next_actionでの制御**:
```json
{
  "action": "await_approval",
  "task_id": "task-001",
  "message": "オーナーの承認を待っています"
}
```

**MCPツールレベルでの権限付与**:
- チャットツール（request_task等）から、タスクステータス変更の権限を持たせる
- 具体的には `backlog → todo`、`backlog → in_progress`、`→ blocked` への遷移
- チャット経由でタスクを作成・管理するエージェントが、ステータス制御も行えるようにする

#### メリット

- チャットからのタスク依頼が完結する（別途ステータス変更操作が不要）
- エージェントが自律的にワークフローを進められる
- E2Eテストで人手介入なしに動作検証可能

#### 実装の方向性

- チャットからのステータス変更は、**依頼者を引数に持つ別メソッド**として実装
  - 例: `update_task_status_for_request(task_id, status, requester_id)`
  - 通常の`update_task_status`とは分離し、チャット経由の依頼に紐づく変更であることを明示
- **上位エージェントからの依頼のみ許可**
  - システム側で依頼者の階層をバリデーション
  - 依頼者が実行エージェントの上位（owner/manager）であることを確認
  - 下位エージェントや同階層からの依頼は拒否
- これにより、誰の依頼に基づくステータス変更かを追跡可能
- 監査ログや履歴管理にも有用

## 追加発見: ステータス変更バリデーションの問題

パイロットテスト実行中に、別の問題が発見された。

### 問題

オーナーがUIからタスクステータスを`backlog`→`todo`に変更した後、ワーカーが自動的に`todo`→`in_progress`へ遷移しようとすると、以下のエラーで拒否される：

```
validationFailed("Cannot change task status. Last status change by pilot-owner. Only self or subordinate workers can modify.")
```

### 原因

`UpdateTaskStatusUseCase`のバリデーションロジックが以下の条件のみを許可：
1. 最終変更者が自分自身
2. 最終変更者が自分の下位ワーカー

オーナーが変更した場合、ワーカーは「オーナーの下位」ではあるが、「オーナーを下位として持つ」わけではないため、拒否される。

### 影響

- タスクの**アサイニー（担当者）が自分のタスクを開始できない**
- UIから`todo`に設定しても、ワーカーは`in_progress`に遷移できず、タスクを取得できない

### 暫定対応

UIから直接`in_progress`に設定することで回避可能（UI操作はエージェント検証をバイパスする）。

### 修正案

`UpdateTaskStatusUseCase`のバリデーションに以下の条件を追加すべき：

```swift
// 3. タスクのアサイニーが自分自身の場合 → 許可
if task.assigneeId == requestingAgent {
    return  // Allow assignee to modify their own task
}
```

これにより、担当者は自分に割り当てられたタスクのステータスを変更できるようになる。

---

## パイロットテストへの暫定対応

仕様改善までの暫定対応として、以下のいずれかが考えられる：

1. **テストシナリオにUI操作（ステータス変更）を追加** - 最も正確だが手間がかかる
   - 現在の実装: オーナーがUIから直接`in_progress`に設定（`todo`ではなく）
2. **マネージャーのシステムプロンプトで`update_task_status`を明示的に呼ぶよう指示** - 現実的な暫定策
3. タスク作成後にテストコードでDB直接更新（非推奨）

改善案が実装された場合は、テストシナリオで「自動承認モード」を有効にするか、承認操作をテストフローに組み込む。

## 関連ドキュメント

- `docs/requirements/TASKS.md` - タスク状態遷移の仕様
- `docs/requirements/AGENTS.md` - エージェント権限の仕様
