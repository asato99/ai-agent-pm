# Webapp Test Scenario - シナリオ定義
#
# webapp-testing スキルの効果を検証するシナリオ
# localStorageの型変換バグを含むショッピングカートアプリ

name: webapp-test
description: "Webアプリテスト - スキル有無による問題発見効率の比較"
version: "1.0"

# プロジェクト設定
project:
  id: pilot-webapp-test
  name: "Webアプリテスト"
  working_directory: /tmp/pilot_webapp_test

# 初期ファイル（テスト対象のWebアプリ）
initial_files:
  - name: index.html
    content: |
      <!DOCTYPE html>
      <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ショッピングカート</title>
        <link rel="stylesheet" href="style.css">
      </head>
      <body>
        <div class="container">
          <h1>ショッピングカート</h1>

          <div class="products">
            <h2>商品一覧</h2>
            <div class="product" data-price="100">
              <span class="name">りんご</span>
              <span class="price">¥100</span>
              <button onclick="addToCart('りんご', 100)">追加</button>
            </div>
            <div class="product" data-price="150">
              <span class="name">バナナ</span>
              <span class="price">¥150</span>
              <button onclick="addToCart('バナナ', 150)">追加</button>
            </div>
            <div class="product" data-price="200">
              <span class="name">みかん</span>
              <span class="price">¥200</span>
              <button onclick="addToCart('みかん', 200)">追加</button>
            </div>
          </div>

          <div class="cart">
            <h2>カート</h2>
            <div id="cart-items"></div>
            <div class="total">
              合計: ¥<span id="total">0</span>
            </div>
            <button onclick="clearCart()">カートをクリア</button>
          </div>
        </div>

        <script type="module" src="app.js"></script>
      </body>
      </html>

  - name: style.css
    content: |
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      h1 {
        margin-bottom: 20px;
        color: #333;
      }

      h2 {
        margin: 20px 0 10px;
        color: #666;
        font-size: 1.1em;
      }

      .product {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }

      .product .name {
        flex: 1;
      }

      .product .price {
        margin-right: 10px;
        color: #e74c3c;
      }

      .product button {
        padding: 5px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .product button:hover {
        background: #2980b9;
      }

      .cart {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #eee;
      }

      #cart-items {
        min-height: 50px;
      }

      .cart-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        color: #666;
      }

      .total {
        font-size: 1.5em;
        font-weight: bold;
        margin: 20px 0;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 4px;
      }

      .cart button {
        padding: 10px 20px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .cart button:hover {
        background: #c0392b;
      }

  - name: data.js
    content: |
      // カートデータの管理
      // localStorageを使用してブラウザに状態を保存

      const STORAGE_KEY = 'shopping_cart';
      const TOTAL_KEY = 'shopping_cart_total';

      /**
       * 保存されたカートデータを読み込む
       */
      export function loadCart() {
        const savedItems = localStorage.getItem(STORAGE_KEY);
        const savedTotal = localStorage.getItem(TOTAL_KEY);

        if (savedItems) {
          return {
            items: JSON.parse(savedItems),
            total: savedTotal || 0  // 文字列のまま返す（バグ）
          };
        }
        return { items: [], total: 0 };
      }

      /**
       * カートデータを保存する
       */
      export function saveCart(cart) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cart.items));
        localStorage.setItem(TOTAL_KEY, cart.total);  // 数値を文字列として保存
      }

      /**
       * カートをクリアする
       */
      export function clearCartData() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(TOTAL_KEY);
      }

  - name: app.js
    content: |
      // ショッピングカート アプリケーション
      import { loadCart, saveCart, clearCartData } from './data.js';

      // カートの状態
      let cart = loadCart();

      // 画面を更新
      function updateDisplay() {
        const itemsContainer = document.getElementById('cart-items');
        const totalElement = document.getElementById('total');

        // カートアイテムを表示
        itemsContainer.innerHTML = cart.items
          .map(item => `<div class="cart-item"><span>${item.name}</span><span>¥${item.price}</span></div>`)
          .join('');

        // 合計を表示
        totalElement.textContent = cart.total;
      }

      // 商品をカートに追加
      window.addToCart = function(name, price) {
        cart.items.push({ name, price });
        cart.total = cart.total + price;
        saveCart(cart);
        updateDisplay();
      };

      // カートをクリア
      window.clearCart = function() {
        cart = { items: [], total: 0 };
        clearCartData();
        updateDisplay();
      };

      // 初期表示
      updateDisplay();

# 期待する成果物
expected_artifacts: []

# 期待するレポート
# AIエージェントが作成する構造化レポート（JSON形式）の検証ルール
expected_report:
  path: TEST_REPORT.json
  format: json
  assertions:
    # テストケースが4件以上実施されている
    - type: min_length
      field: test_cases
      min: 4

    # バグが1件以上発見されている
    - type: min_length
      field: bugs_found
      min: 1

# タイムアウト設定（秒）
timeouts:
  task_creation: 300      # タスク作成待ち
  task_completion: 600    # テスト完了待ち（10分）

# 初期アクション
initial_action:
  type: chat
  from: owner-webapp-test
  to: worker-tester
  message: |
    作業ディレクトリにあるショッピングカートアプリケーションのテストを実施してください。

    ## アプリの要件

    ### 基本機能
    - 商品（りんご¥100、バナナ¥150、みかん¥200）をカートに追加できる
    - 合計金額が正しく計算される
    - 「カートをクリア」ボタンでカートを空にできる

    ### データ永続性
    - カートの状態はブラウザのlocalStorageに保存される
    - ページをリロードしても状態が復元される
    - リロード後に商品を追加しても、合計金額が正しく計算される

    ## 注意事項
    - バグを発見した場合は記録してください（原因調査は不要）

    ## 成果物要件（必須）
    テスト完了後、作業ディレクトリに `TEST_REPORT.json` を作成してください。

    **重要: 以下のフィールド名を正確に使用してください（自動検証されます）**

    必須フィールド:
    - `test_cases` (配列): テストケースを格納 ※ test_results ではありません
    - `bugs_found` (配列): 発見したバグを格納
    - `test_completed` (boolean): 必ず true を設定

    ```json
    {
      "summary": "テスト結果の概要",
      "test_completed": true,
      "test_cases": [
        {
          "id": "TC01",
          "name": "テストケース名",
          "steps": ["実施した手順1", "手順2"],
          "expected": "期待結果",
          "actual": "実際の結果",
          "passed": true
        }
      ],
      "bugs_found": [
        {
          "description": "発見したバグの内容",
          "test_case_id": "関連するテストケースID",
          "reproduction_steps": ["再現手順1", "再現手順2"],
          "severity": "high/medium/low"
        }
      ],
      "environment": {
        "browser": "使用したブラウザ"
      }
    }
    ```

    - すべてのテストケースを `test_cases` 配列に記録してください（4件以上）
    - バグを発見しなかった場合は `bugs_found` を空配列にしてください
    - レポート作成後、タスクを完了にしてください
