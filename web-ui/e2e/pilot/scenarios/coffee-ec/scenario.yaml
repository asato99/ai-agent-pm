# Coffee EC Scenario
#
# コーヒー豆専門ECサイト開発シナリオ
# カスタマイズ注文とレビューシステムを含む中程度の複雑さ

name: coffee-ec
description: "コーヒー豆専門ECサイト - カスタマイズ注文・レビュー機能付き"
version: "1.0"

# プロジェクト設定
project:
  id: pilot-coffee-ec
  name: "コーヒー豆専門ECサイト"
  working_directory: /tmp/pilot_coffee_ec

# 初期ファイル（仕様書を配置）
initial_files:
  - name: SPEC.md
    content: |
      # コーヒー豆専門ECサイト 仕様書

      ## 1. 概要

      スペシャルティコーヒー豆を販売するECサイト。
      商品のカスタマイズ注文（焙煎度・挽き方・内容量）に対応し、
      テイスティングノート付きのレビューシステムを備える。

      ## 2. 技術要件

      - HTML/CSS/JavaScript（バニラJS、フレームワーク不要）
      - レスポンシブデザイン対応
      - localStorage使用（カート、お気に入り保存）
      - モック商品データ（JavaScript内で定義）
      - 外部ライブラリ: Chart.js（テイスティングチャート用、CDN）

      ## 3. データモデル

      ### 3.1 商品（Product）
      ```
      {
        id: string,
        name: string,                    // 商品名
        origin: string,                  // 産地（エチオピア、ブラジル等）
        region: string,                  // 地域詳細
        description: string,             // 商品説明
        basePrice: number,               // 基本価格（100gあたり）
        category: string,                // カテゴリ（シングルオリジン/ブレンド）
        roastLevels: string[],           // 選択可能な焙煎度
        flavorProfile: {                 // 風味プロファイル
          acidity: number,               // 酸味 (1-5)
          bitterness: number,            // 苦味 (1-5)
          body: number,                  // コク (1-5)
          sweetness: number,             // 甘味 (1-5)
          aroma: number                  // 香り (1-5)
        },
        flavorNotes: string[],           // フレーバーノート（ベリー、チョコレート等）
        images: string[],                // 商品画像URL
        stock: number,                   // 在庫数
        rating: number,                  // 平均評価
        reviewCount: number              // レビュー数
      }
      ```

      ### 3.2 カート商品（CartItem）
      ```
      {
        productId: string,
        quantity: number,
        roastLevel: string,              // 選択した焙煎度
        grindType: string,               // 挽き方
        weight: number,                  // 内容量(g)
        unitPrice: number,               // 単価（計算後）
        subtotal: number                 // 小計
      }
      ```

      ### 3.3 レビュー（Review）
      ```
      {
        id: string,
        productId: string,
        userName: string,
        rating: number,                  // 星評価 (1-5)
        tastingNote: {                   // テイスティング評価
          acidity: number,
          bitterness: number,
          body: number,
          sweetness: number,
          aroma: number
        },
        comment: string,
        brewMethod: string,              // 抽出方法
        createdAt: string
      }
      ```

      ## 4. 機能要件

      ### 4.1 商品一覧ページ

      #### 検索・フィルタ
      - キーワード検索（商品名、産地、フレーバーノート）
      - カテゴリフィルタ（シングルオリジン/ブレンド/全て）
      - 産地フィルタ（複数選択可）
      - 焙煎度フィルタ
      - 価格帯フィルタ（スライダーまたは範囲選択）

      #### ソート
      - 価格順（安い/高い）
      - 評価順
      - 新着順
      - 人気順（レビュー数）

      #### 表示
      - グリッド表示（3-4列）
      - 各商品: 画像、商品名、産地、価格、評価星
      - ページネーション（1ページ12件）

      ### 4.2 商品詳細ページ

      #### 商品情報表示
      - 商品画像（メイン + サムネイル切り替え）
      - 商品名、産地、地域
      - 商品説明
      - フレーバーノート（タグ表示）
      - テイスティングチャート（レーダーチャート）
      - 在庫状況

      #### カスタマイズ選択
      - 焙煎度選択（ライト/ミディアム/ダーク）
        - 選択で価格変動なし
      - 挽き方選択
        - 豆のまま（+0円）
        - 粗挽き（+50円）
        - 中挽き（+50円）
        - 細挽き（+50円）
        - エスプレッソ用（+100円）
      - 内容量選択
        - 100g: 基本価格 × 1.0
        - 200g: 基本価格 × 1.9（5%OFF）
        - 500g: 基本価格 × 4.5（10%OFF）

      #### 価格表示
      - 選択に応じて動的に価格更新
      - 内訳表示（基本価格 + オプション）

      #### アクション
      - 数量選択（1-10）
      - カートに追加ボタン
      - お気に入りに追加ボタン

      #### レビューセクション
      - 平均評価と評価分布
      - ユーザーレビュー一覧
      - レビュー投稿フォーム

      ### 4.3 ショッピングカート

      #### カート表示
      - 商品一覧（画像、名前、カスタマイズ内容、単価、数量、小計）
      - 数量変更（+/-ボタン）
      - 商品削除
      - カート内商品数バッジ（ヘッダー）

      #### 金額計算
      - 小計
      - 送料（5,000円以上で無料、未満は500円）
      - クーポン割引（適用時）
      - 合計金額

      #### クーポン
      - クーポンコード入力欄
      - 適用ボタン
      - 有効なコード: "FIRST10"（10%OFF）, "COFFEE20"（20%OFF）

      #### アクション
      - 買い物を続けるボタン
      - レジに進むボタン

      ### 4.4 チェックアウト（マルチステップ）

      #### Step 1: 配送先情報
      - 氏名（必須）
      - 郵便番号（必須、形式チェック）
      - 都道府県（必須、セレクト）
      - 市区町村（必須）
      - 番地（必須）
      - 建物名（任意）
      - 電話番号（必須、形式チェック）
      - メールアドレス（必須、形式チェック）

      #### Step 2: 支払い方法
      - クレジットカード（モック）
        - カード番号（形式チェック）
        - 有効期限
        - セキュリティコード
      - 代金引換（+300円手数料）
      - 銀行振込（振込先表示）

      #### Step 3: 注文確認
      - 注文内容一覧
      - 配送先確認
      - 支払い方法確認
      - 最終金額確認
      - 注文確定ボタン

      #### Step 4: 注文完了
      - 注文番号表示
      - 注文完了メッセージ
      - 注文詳細へのリンク
      - トップに戻るボタン

      ### 4.5 レビュー機能

      #### レビュー表示
      - 星評価（1-5）
      - テイスティングノート（レーダーチャート）
      - コメント
      - 抽出方法
      - 投稿日
      - 「参考になった」ボタン

      #### レビュー投稿
      - 星評価選択（クリッカブル星）
      - テイスティング評価（各項目スライダー）
      - 抽出方法選択
      - コメント入力
      - 投稿ボタン

      ### 4.6 お気に入り機能

      - 商品詳細からお気に入り追加/削除
      - お気に入り一覧ページ
      - localStorage永続化

      ### 4.7 共通UI

      #### ヘッダー
      - ロゴ
      - 検索バー
      - お気に入りアイコン（件数バッジ）
      - カートアイコン（件数バッジ）

      #### フッター
      - サイト情報
      - リンク

      ### 4.8 状態表示
      - ローディングインジケーター
      - エラーメッセージ
      - 成功メッセージ（トースト通知）

      ## 5. UI/デザイン要件

      - モダンでクリーンなデザイン
      - コーヒーをイメージした配色（ブラウン系アクセント）
      - カード型レイアウト
      - レスポンシブ対応（モバイル/タブレット/デスクトップ）
      - スムーズなアニメーション/トランジション

      ## 6. モック商品データ

      最低8商品を用意:
      1. エチオピア イルガチェフェ（シングルオリジン）
      2. ブラジル サントス（シングルオリジン）
      3. コロンビア スプレモ（シングルオリジン）
      4. グアテマラ アンティグア（シングルオリジン）
      5. ケニア AA（シングルオリジン）
      6. モカブレンド（ブレンド）
      7. ハウスブレンド（ブレンド）
      8. エスプレッソブレンド（ブレンド）

      ## 7. テスト用識別子（data-testid）

      ### ヘッダー
      - header-logo: ロゴ
      - header-search: 検索入力
      - header-search-button: 検索ボタン
      - header-favorites: お気に入りアイコン
      - header-cart: カートアイコン
      - cart-badge: カート件数バッジ

      ### 商品一覧
      - product-list: 商品一覧コンテナ
      - product-card: 商品カード（複数）
      - filter-category: カテゴリフィルタ
      - filter-origin: 産地フィルタ
      - filter-roast: 焙煎度フィルタ
      - filter-price-min: 価格下限
      - filter-price-max: 価格上限
      - sort-select: ソート選択
      - pagination: ページネーション
      - page-prev: 前ページ
      - page-next: 次ページ

      ### 商品詳細
      - product-name: 商品名
      - product-origin: 産地
      - product-description: 商品説明
      - product-price: 価格表示
      - product-image-main: メイン画像
      - product-stock: 在庫状況
      - flavor-chart: テイスティングチャート
      - flavor-notes: フレーバーノート
      - select-roast: 焙煎度選択
      - select-grind: 挽き方選択
      - select-weight: 内容量選択
      - quantity-input: 数量入力
      - quantity-minus: 数量減少
      - quantity-plus: 数量増加
      - add-to-cart: カートに追加
      - add-to-favorites: お気に入りに追加

      ### レビュー
      - review-section: レビューセクション
      - review-average: 平均評価
      - review-count: レビュー数
      - review-list: レビュー一覧
      - review-item: レビュー項目（複数）
      - review-form: レビュー投稿フォーム
      - review-rating-input: 星評価入力
      - review-comment: コメント入力
      - review-brew-method: 抽出方法選択
      - review-submit: レビュー投稿ボタン
      - tasting-acidity: 酸味スライダー
      - tasting-bitterness: 苦味スライダー
      - tasting-body: コクスライダー
      - tasting-sweetness: 甘味スライダー
      - tasting-aroma: 香りスライダー

      ### カート
      - cart-container: カートコンテナ
      - cart-items: カート商品一覧
      - cart-item: カート商品（複数）
      - cart-item-name: 商品名
      - cart-item-options: カスタマイズ内容
      - cart-item-price: 単価
      - cart-item-quantity: 数量
      - cart-item-subtotal: 小計
      - cart-item-remove: 削除ボタン
      - cart-subtotal: カート小計
      - cart-shipping: 送料
      - cart-discount: 割引額
      - cart-total: 合計金額
      - coupon-input: クーポン入力
      - coupon-apply: クーポン適用ボタン
      - continue-shopping: 買い物を続ける
      - proceed-checkout: レジに進む

      ### チェックアウト
      - checkout-steps: ステップ表示
      - checkout-step-1: ステップ1
      - checkout-step-2: ステップ2
      - checkout-step-3: ステップ3
      - checkout-step-4: ステップ4

      #### 配送先フォーム
      - input-name: 氏名
      - input-postal: 郵便番号
      - input-prefecture: 都道府県
      - input-city: 市区町村
      - input-address: 番地
      - input-building: 建物名
      - input-phone: 電話番号
      - input-email: メールアドレス

      #### 支払い方法
      - payment-credit: クレジットカード選択
      - payment-cod: 代金引換選択
      - payment-bank: 銀行振込選択
      - input-card-number: カード番号
      - input-card-expiry: 有効期限
      - input-card-cvc: セキュリティコード

      #### ナビゲーション
      - btn-next-step: 次へボタン
      - btn-prev-step: 戻るボタン
      - btn-place-order: 注文確定ボタン

      #### 注文完了
      - order-complete: 注文完了画面
      - order-number: 注文番号
      - btn-back-home: トップに戻る

      ### 状態
      - loading-indicator: ローディング
      - error-message: エラーメッセージ
      - success-toast: 成功通知

      ### お気に入り
      - favorites-page: お気に入りページ
      - favorites-list: お気に入り一覧
      - favorites-empty: 空状態メッセージ

      ## 8. Level 3 検討機能（将来拡張）

      以下の機能は将来の拡張として検討:

      ### 8.1 定期購入（サブスクリプション）
      - 配送頻度選択（毎週/隔週/毎月）
      - 定期購入割引（10%OFF）
      - スキップ/一時停止/解約機能
      - 次回配送日の管理・変更
      - マイページでの定期便管理

      ### 8.2 ギフト機能
      - ギフトラッピングオプション（+300円）
      - メッセージカード入力（最大200文字）
      - 送り先を購入者と別に指定
      - 納品書なし配送オプション
      - ギフト用パッケージ画像表示

      ### 8.3 その他検討機能
      - 好み診断クイズ → レコメンド
      - ポイント/ロイヤリティシステム
      - 入荷通知登録
      - 限定商品の予約販売

# 期待する成果物
expected_artifacts:
  - path: index.html
    description: "メインHTMLファイル（SPA or エントリーポイント）"
  - path: products.json
    description: "モック商品データ（オプション、JS内定義でも可）"

# タイムアウト設定（秒）
timeouts:
  task_creation: 900
  task_completion: 7200   # 120分（複雑な機能のため）

# 初期アクション
initial_action:
  type: chat
  from: owner-coffee
  to: worker-dev
  message: |
    作業ディレクトリにある SPEC.md を参照して、コーヒー豆専門ECサイトを実装してください。

    要件：
    - 実際に動作するアプリを作成
    - モック商品データを使用（最低8商品）
    - 仕様書に記載された全てのdata-testid属性を実装
    - カスタマイズ注文（焙煎度・挽き方・内容量）に対応
    - レビュー機能（テイスティングチャート付き）を実装
    - チェックアウトはマルチステップで実装
    - 成果物は作業ディレクトリに保存

# E2Eテストケース
e2e_tests:
  # ========== 構造テスト ==========
  - id: ST-01
    name: "ヘッダー構造確認"
    steps:
      - action: assert_exists
        selector: '[data-testid="header-logo"]'
      - action: assert_exists
        selector: '[data-testid="header-search"]'
      - action: assert_exists
        selector: '[data-testid="header-cart"]'

  - id: ST-02
    name: "商品一覧構造確認"
    steps:
      - action: assert_exists
        selector: '[data-testid="product-list"]'
      - action: assert_exists
        selector: '[data-testid="filter-category"]'
      - action: assert_exists
        selector: '[data-testid="sort-select"]'

  - id: ST-03
    name: "商品カード表示確認"
    steps:
      - action: assert_exists
        selector: '[data-testid="product-card"]'
      - action: assert_count_min
        selector: '[data-testid="product-card"]'
        min: 8

  # ========== 検索・フィルタテスト ==========
  - id: SF-01
    name: "キーワード検索"
    steps:
      - action: fill
        selector: '[data-testid="header-search"]'
        value: "エチオピア"
      - action: click
        selector: '[data-testid="header-search-button"]'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="product-card"]'

  - id: SF-02
    name: "カテゴリフィルタ"
    steps:
      - action: click
        selector: '[data-testid="filter-category"]'
      - action: select
        selector: '[data-testid="filter-category"]'
        value: "blend"
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="product-card"]'

  - id: SF-03
    name: "ソート機能"
    steps:
      - action: select
        selector: '[data-testid="sort-select"]'
        value: "price-asc"
      - action: wait
        timeout: 500
      - action: assert_exists
        selector: '[data-testid="product-card"]'

  # ========== 商品詳細テスト ==========
  - id: PD-01
    name: "商品詳細ページ表示"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="product-name"]'
      - action: assert_exists
        selector: '[data-testid="product-price"]'
      - action: assert_exists
        selector: '[data-testid="flavor-chart"]'

  - id: PD-02
    name: "カスタマイズ選択UI"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="select-roast"]'
      - action: assert_exists
        selector: '[data-testid="select-grind"]'
      - action: assert_exists
        selector: '[data-testid="select-weight"]'

  - id: PD-03
    name: "カスタマイズで価格変動"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: get_text
        selector: '[data-testid="product-price"]'
        store: initial_price
      - action: select
        selector: '[data-testid="select-weight"]'
        value: "200"
      - action: wait
        timeout: 500
      - action: assert_text_changed
        selector: '[data-testid="product-price"]'
        from: initial_price

  # ========== カート機能テスト ==========
  - id: CT-01
    name: "カートに追加"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: click
        selector: '[data-testid="add-to-cart"]'
      - action: wait
        timeout: 500
      - action: assert_exists
        selector: '[data-testid="cart-badge"]'
      - action: assert_text
        selector: '[data-testid="cart-badge"]'
        expected: "1"

  - id: CT-02
    name: "カートページ表示"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: click
        selector: '[data-testid="add-to-cart"]'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="header-cart"]'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="cart-container"]'
      - action: assert_exists
        selector: '[data-testid="cart-item"]'

  - id: CT-03
    name: "カート数量変更"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="add-to-cart"]'
      - action: click
        selector: '[data-testid="header-cart"]'
      - action: wait
        timeout: 1000
      - action: click
        selector: '[data-testid="cart-item"]:first-child [data-testid="quantity-plus"]'
      - action: wait
        timeout: 500
      - action: assert_text
        selector: '[data-testid="cart-item"]:first-child [data-testid="cart-item-quantity"]'
        expected: "2"

  - id: CT-04
    name: "クーポン適用"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="add-to-cart"]'
      - action: click
        selector: '[data-testid="header-cart"]'
      - action: wait
        timeout: 1000
      - action: fill
        selector: '[data-testid="coupon-input"]'
        value: "FIRST10"
      - action: click
        selector: '[data-testid="coupon-apply"]'
      - action: wait
        timeout: 500
      - action: assert_exists
        selector: '[data-testid="cart-discount"]'

  # ========== チェックアウトテスト ==========
  - id: CO-01
    name: "チェックアウト開始"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="add-to-cart"]'
      - action: click
        selector: '[data-testid="header-cart"]'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="proceed-checkout"]'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="checkout-step-1"]'

  - id: CO-02
    name: "配送先入力バリデーション"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="add-to-cart"]'
      - action: click
        selector: '[data-testid="header-cart"]'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="proceed-checkout"]'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="btn-next-step"]'
      - action: wait
        timeout: 500
      - action: assert_exists
        selector: '[data-testid="error-message"]'

  - id: CO-03
    name: "チェックアウト完了フロー"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="add-to-cart"]'
      - action: click
        selector: '[data-testid="header-cart"]'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="proceed-checkout"]'
      - action: wait
        timeout: 500
      # Step 1: 配送先
      - action: fill
        selector: '[data-testid="input-name"]'
        value: "山田太郎"
      - action: fill
        selector: '[data-testid="input-postal"]'
        value: "123-4567"
      - action: select
        selector: '[data-testid="input-prefecture"]'
        value: "東京都"
      - action: fill
        selector: '[data-testid="input-city"]'
        value: "渋谷区"
      - action: fill
        selector: '[data-testid="input-address"]'
        value: "1-2-3"
      - action: fill
        selector: '[data-testid="input-phone"]'
        value: "090-1234-5678"
      - action: fill
        selector: '[data-testid="input-email"]'
        value: "test@example.com"
      - action: click
        selector: '[data-testid="btn-next-step"]'
      - action: wait
        timeout: 500
      # Step 2: 支払い方法
      - action: assert_exists
        selector: '[data-testid="checkout-step-2"]'
      - action: click
        selector: '[data-testid="payment-cod"]'
      - action: click
        selector: '[data-testid="btn-next-step"]'
      - action: wait
        timeout: 500
      # Step 3: 確認
      - action: assert_exists
        selector: '[data-testid="checkout-step-3"]'
      - action: click
        selector: '[data-testid="btn-place-order"]'
      - action: wait
        timeout: 1000
      # Step 4: 完了
      - action: assert_exists
        selector: '[data-testid="order-complete"]'
      - action: assert_exists
        selector: '[data-testid="order-number"]'

  # ========== レビュー機能テスト ==========
  - id: RV-01
    name: "レビュー表示"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="review-section"]'
      - action: assert_exists
        selector: '[data-testid="review-average"]'

  - id: RV-02
    name: "レビュー投稿フォーム"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="review-form"]'
      - action: assert_exists
        selector: '[data-testid="review-rating-input"]'
      - action: assert_exists
        selector: '[data-testid="tasting-acidity"]'

  # ========== お気に入り機能テスト ==========
  - id: FV-01
    name: "お気に入り追加"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: wait
        timeout: 1000
      - action: click
        selector: '[data-testid="add-to-favorites"]'
      - action: wait
        timeout: 500
      - action: click
        selector: '[data-testid="header-favorites"]'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="favorites-list"]'

  # ========== ページネーションテスト ==========
  - id: PG-01
    name: "ページネーション動作"
    steps:
      - action: assert_exists
        selector: '[data-testid="pagination"]'
      - action: click
        selector: '[data-testid="page-next"]'
      - action: wait
        timeout: 1000
      - action: assert_exists
        selector: '[data-testid="product-card"]'

  # ========== レスポンシブテスト ==========
  - id: RS-01
    name: "モバイル表示"
    steps:
      - action: resize
        width: 375
        height: 667
      - action: wait
        timeout: 500
      - action: assert_exists
        selector: '[data-testid="product-list"]'
      - action: assert_exists
        selector: '[data-testid="header-cart"]'

  # ========== 状態表示テスト ==========
  - id: LD-01
    name: "ローディング表示"
    steps:
      - action: click
        selector: '[data-testid="product-card"]:first-child'
      - action: assert_exists
        selector: '[data-testid="loading-indicator"]'
