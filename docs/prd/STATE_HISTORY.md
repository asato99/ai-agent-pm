# çŠ¶æ…‹å¤‰æ›´å±¥æ­´è¨­è¨ˆ

ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®çŠ¶æ…‹å¤‰æ›´ã‚’å®Œå…¨ã«ä¿æŒã—ã€ã„ã¤ã§ã‚‚å‚ç…§ãƒ»ç›£æŸ»ã§ãã‚‹ä»•çµ„ã¿ã€‚

---

## è¨­è¨ˆæ€æƒ³

### ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã®æ¡ç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  å¾“æ¥ã®CRUDæ–¹å¼:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  UPDATE  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ Task    â”‚ â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Task    â”‚  â€»éå»ã®çŠ¶æ…‹ã¯å¤±ã‚ã‚Œã‚‹      â”‚
â”‚  â”‚ status: â”‚          â”‚ status: â”‚                              â”‚
â”‚  â”‚ "todo"  â”‚          â”‚ "done"  â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                  â”‚
â”‚  ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°æ–¹å¼:                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Created â”‚â†’ â”‚ Started â”‚â†’ â”‚ Reviewedâ”‚â†’ â”‚Completedâ”‚          â”‚
â”‚  â”‚ "todo"  â”‚  â”‚"progress"â”‚  â”‚"review" â”‚  â”‚ "done"  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚       â†‘           â†‘            â†‘            â†‘                  â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚              ã™ã¹ã¦ã®å±¥æ­´ã‚’ä¿æŒ                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŸå‰‡

1. **è¿½è¨˜ã®ã¿ (Append-Only)**: å±¥æ­´ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯å‰Šé™¤ãƒ»æ›´æ–°ã—ãªã„
2. **å®Œå…¨æ€§**: ã™ã¹ã¦ã®çŠ¶æ…‹å¤‰æ›´ã‚’è¨˜éŒ²
3. **è¿½è·¡å¯èƒ½æ€§**: èª°ãŒã€ã„ã¤ã€ä½•ã‚’ã€ãªãœå¤‰æ›´ã—ãŸã‹
4. **å†æ§‹ç¯‰å¯èƒ½**: å±¥æ­´ã‹ã‚‰ä»»æ„æ™‚ç‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒå¯èƒ½

---

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### å±¥æ­´ã‚¤ãƒ™ãƒ³ãƒˆ (StateChangeEvent)

```swift
struct StateChangeEvent {
    let id: EventID                    // evt_xxx
    let entityType: EntityType         // å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç¨®é¡
    let entityId: String               // å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ID
    let eventType: EventType           // ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡
    let changes: [FieldChange]         // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    let actorId: AgentID               // å¤‰æ›´ã‚’è¡Œã£ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    let sessionId: SessionID?          // å¤‰æ›´æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ (AIçµŒç”±ã®å ´åˆ)
    let reason: String?                // å¤‰æ›´ç†ç”± (ä»»æ„)
    let metadata: [String: Any]?       // è¿½åŠ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    let timestamp: Date                // å¤‰æ›´æ—¥æ™‚
}
```

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ (FieldChange)

```swift
struct FieldChange {
    let field: String                  // å¤‰æ›´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
    let oldValue: AnyCodable?          // å¤‰æ›´å‰ã®å€¤
    let newValue: AnyCodable?          // å¤‰æ›´å¾Œã®å€¤
}
```

### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç¨®é¡ (EntityType)

```swift
enum EntityType: String, Codable {
    case project = "project"
    case task = "task"
    case agent = "agent"
    case session = "session"
    case handoff = "handoff"
    case context = "context"
}
```

### ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡ (EventType)

```swift
enum EventType: String, Codable {
    // æ±ç”¨
    case created = "created"
    case updated = "updated"
    case deleted = "deleted"
    case archived = "archived"
    case restored = "restored"

    // ã‚¿ã‚¹ã‚¯å›ºæœ‰
    case statusChanged = "status_changed"
    case assigned = "assigned"
    case unassigned = "unassigned"
    case priorityChanged = "priority_changed"
    case dependencyAdded = "dependency_added"
    case dependencyRemoved = "dependency_removed"

    // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰
    case roleChanged = "role_changed"
    case permissionChanged = "permission_changed"
    case activated = "activated"
    case deactivated = "deactivated"

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰
    case sessionStarted = "session_started"
    case sessionEnded = "session_ended"

    // ãƒãƒ³ãƒ‰ã‚ªãƒ•å›ºæœ‰
    case handoffCreated = "handoff_created"
    case handoffAcknowledged = "handoff_acknowledged"
    case handoffCompleted = "handoff_completed"

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå›ºæœ‰
    case contextAdded = "context_added"
    case contextUpdated = "context_updated"
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

### state_change_events ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE state_change_events (
    id TEXT PRIMARY KEY,                    -- evt_xxx
    entity_type TEXT NOT NULL,              -- project, task, agent, etc.
    entity_id TEXT NOT NULL,                -- å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID
    event_type TEXT NOT NULL,               -- created, updated, etc.
    changes JSON NOT NULL,                  -- [{"field": "status", "old": "todo", "new": "done"}]
    actor_id TEXT NOT NULL,                 -- å¤‰æ›´è€…ã®Agent ID
    session_id TEXT,                        -- ã‚»ãƒƒã‚·ãƒ§ãƒ³ID (nullable)
    reason TEXT,                            -- å¤‰æ›´ç†ç”± (nullable)
    metadata JSON,                          -- è¿½åŠ æƒ…å ± (nullable)
    timestamp TEXT NOT NULL,                -- ISO8601å½¢å¼

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”¨
    FOREIGN KEY (actor_id) REFERENCES agents(id),
    FOREIGN KEY (session_id) REFERENCES sessions(id)
);

-- æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_events_entity ON state_change_events(entity_type, entity_id);
CREATE INDEX idx_events_actor ON state_change_events(actor_id);
CREATE INDEX idx_events_timestamp ON state_change_events(timestamp);
CREATE INDEX idx_events_type ON state_change_events(event_type);
```

### ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ä¾‹

```json
{
    "id": "evt_a1b2c3d4e5f6",
    "entity_type": "task",
    "entity_id": "tsk_xyz789",
    "event_type": "status_changed",
    "changes": [
        {
            "field": "status",
            "old": "in_progress",
            "new": "review"
        }
    ],
    "actor_id": "agt_frontend01",
    "session_id": "ses_abc123",
    "reason": "å®Ÿè£…å®Œäº†ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼",
    "metadata": {
        "commit_hash": "a1b2c3d",
        "files_changed": 5
    },
    "timestamp": "2024-12-30T14:30:00Z"
}
```

---

## è¨˜éŒ²å¯¾è±¡ã‚¤ãƒ™ãƒ³ãƒˆ

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ (Project)

| ã‚¤ãƒ™ãƒ³ãƒˆ | è¨˜éŒ²å†…å®¹ |
|---------|---------|
| created | åå‰ã€èª¬æ˜ã€ä½œæˆè€… |
| updated | å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ |
| archived | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”± |
| restored | å¾©å…ƒç†ç”± |

### ã‚¿ã‚¹ã‚¯ (Task)

| ã‚¤ãƒ™ãƒ³ãƒˆ | è¨˜éŒ²å†…å®¹ |
|---------|---------|
| created | ã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€å„ªå…ˆåº¦ã€æ‹…å½“è€…ã€ä¾å­˜é–¢ä¿‚ |
| status_changed | å¤‰æ›´å‰å¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| assigned | æ–°ã—ã„æ‹…å½“è€… |
| unassigned | å…ƒã®æ‹…å½“è€… |
| priority_changed | å¤‰æ›´å‰å¾Œã®å„ªå…ˆåº¦ |
| dependency_added | è¿½åŠ ã•ã‚ŒãŸä¾å­˜ã‚¿ã‚¹ã‚¯ |
| dependency_removed | å‰Šé™¤ã•ã‚ŒãŸä¾å­˜ã‚¿ã‚¹ã‚¯ |
| updated | ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ |
| deleted | å‰Šé™¤ç†ç”± |

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (Agent)

| ã‚¤ãƒ™ãƒ³ãƒˆ | è¨˜éŒ²å†…å®¹ |
|---------|---------|
| created | åå‰ã€å½¹å‰²ã€ã‚¿ã‚¤ãƒ—ã€æ¨©é™ |
| role_changed | å¤‰æ›´å‰å¾Œã®å½¹å‰² |
| permission_changed | å¤‰æ›´å‰å¾Œã®æ¨©é™ã‚¿ã‚¤ãƒ— |
| activated | æœ‰åŠ¹åŒ– |
| deactivated | ç„¡åŠ¹åŒ–ç†ç”± |
| archived | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”± |
| updated | ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ |

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ (Session)

| ã‚¤ãƒ™ãƒ³ãƒˆ | è¨˜éŒ²å†…å®¹ |
|---------|---------|
| session_started | ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ãƒ„ãƒ¼ãƒ«ç¨®é¡ |
| session_ended | çµ‚äº†æ™‚ã‚µãƒãƒª |

### ãƒãƒ³ãƒ‰ã‚ªãƒ• (Handoff)

| ã‚¤ãƒ™ãƒ³ãƒˆ | è¨˜éŒ²å†…å®¹ |
|---------|---------|
| handoff_created | é€ä¿¡å…ƒã€é€ä¿¡å…ˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| handoff_acknowledged | ç¢ºèªè€… |
| handoff_completed | å®Œäº†æ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |

### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ (Context)

| ã‚¤ãƒ™ãƒ³ãƒˆ | è¨˜éŒ²å†…å®¹ |
|---------|---------|
| context_added | å†…å®¹ã€ç¨®é¡ |
| context_updated | å¤‰æ›´å†…å®¹ |

---

## å‚ç…§API

### å±¥æ­´å–å¾—ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```swift
protocol StateHistoryRepository {
    /// ç‰¹å®šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å±¥æ­´ã‚’å–å¾—
    func getHistory(
        entityType: EntityType,
        entityId: String,
        limit: Int?,
        offset: Int?
    ) async throws -> [StateChangeEvent]

    /// ç‰¹å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹å¤‰æ›´å±¥æ­´ã‚’å–å¾—
    func getHistoryByActor(
        actorId: AgentID,
        from: Date?,
        to: Date?,
        limit: Int?
    ) async throws -> [StateChangeEvent]

    /// ç‰¹å®šã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡ã®å±¥æ­´ã‚’å–å¾—
    func getHistoryByEventType(
        eventType: EventType,
        entityType: EntityType?,
        from: Date?,
        to: Date?,
        limit: Int?
    ) async throws -> [StateChangeEvent]

    /// ä»»æ„æ™‚ç‚¹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£çŠ¶æ…‹ã‚’å¾©å…ƒ
    func reconstructState<T: Reconstructable>(
        entityType: EntityType,
        entityId: String,
        at: Date
    ) async throws -> T?

    /// ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
    func recordEvent(_ event: StateChangeEvent) async throws
}
```

### MCP Tools

```yaml
tools:
  # å±¥æ­´å–å¾—
  - name: get_entity_history
    description: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®å¤‰æ›´å±¥æ­´ã‚’å–å¾—
    parameters:
      entity_type: string    # task, agent, handoff, etc.
      entity_id: string      # ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID
      limit: number?         # å–å¾—ä»¶æ•° (default: 50)
      offset: number?        # ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    returns:
      events: StateChangeEvent[]

  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ´»å‹•å±¥æ­´
  - name: get_agent_activity
    description: ç‰¹å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ´»å‹•å±¥æ­´ã‚’å–å¾—
    parameters:
      agent_id: string
      from: string?          # ISO8601
      to: string?            # ISO8601
      limit: number?
    returns:
      events: StateChangeEvent[]

  # ã‚¿ã‚¹ã‚¯çŠ¶æ…‹æ¨ç§»
  - name: get_task_transitions
    description: ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´ã‚’å–å¾—
    parameters:
      task_id: string
    returns:
      transitions: StatusTransition[]

  # æ™‚ç‚¹æŒ‡å®šã®çŠ¶æ…‹å–å¾—
  - name: get_state_at
    description: æŒ‡å®šæ™‚ç‚¹ã§ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£çŠ¶æ…‹ã‚’å–å¾—
    parameters:
      entity_type: string
      entity_id: string
      at: string             # ISO8601
    returns:
      state: Entity
```

---

## UIã§ã®è¡¨ç¤º

### ã‚¿ã‚¹ã‚¯è©³ç´°ã®å±¥æ­´ã‚¿ãƒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ APIå®Ÿè£…ã‚¿ã‚¹ã‚¯                                        [Ã—]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŸºæœ¬æƒ…å ±] [ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ] [ãƒãƒ³ãƒ‰ã‚ªãƒ•] [å±¥æ­´]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”€â”€â”€ å¤‰æ›´å±¥æ­´ â”€â”€â”€                                 [ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼â–¼] â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“… 2024-12-30                                                  â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 14:30  ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´                                   â”‚
â”‚  â”‚         ğŸ¤– frontend-dev                                      â”‚
â”‚  â”‚         in_progress â†’ review                                 â”‚
â”‚  â”‚         ç†ç”±: "å®Ÿè£…å®Œäº†ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼"                       â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 10:15  ğŸ‘¤ æ‹…å½“è€…å¤‰æ›´                                       â”‚
â”‚  â”‚         ğŸ‘¤ owner                                             â”‚
â”‚  â”‚         (æœªã‚¢ã‚µã‚¤ãƒ³) â†’ frontend-dev                          â”‚
â”‚  â”‚                                                               â”‚
â”‚  ğŸ“… 2024-12-29                                                  â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 16:00  ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´                                   â”‚
â”‚  â”‚         ğŸ‘¤ owner                                             â”‚
â”‚  â”‚         backlog â†’ todo                                       â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 15:45  âš¡ å„ªå…ˆåº¦å¤‰æ›´                                       â”‚
â”‚  â”‚         ğŸ‘¤ owner                                             â”‚
â”‚  â”‚         medium â†’ high                                        â”‚
â”‚  â”‚         ç†ç”±: "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦æœ›ã«ã‚ˆã‚Šå„ªå…ˆåº¦ä¸Šã’"             â”‚
â”‚  â”‚                                                               â”‚
â”‚  â””â”€ 15:30  âœ¨ ä½œæˆ                                              â”‚
â”‚            ğŸ‘¤ owner                                             â”‚
â”‚            ã‚¿ã‚¹ã‚¯ "APIå®Ÿè£…" ã‚’ä½œæˆ                              â”‚
â”‚                                                                  â”‚
â”‚  [ã•ã‚‰ã«èª­ã¿è¾¼ã‚€]                                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ´»å‹•ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤– frontend-dev ã®æ´»å‹•                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“… ä»Šæ—¥                                                        â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 14:30  ğŸ“‹ APIå®Ÿè£…                                          â”‚
â”‚  â”‚         ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ review ã«å¤‰æ›´                           â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 14:00  ğŸ’¬ ãƒãƒ³ãƒ‰ã‚ªãƒ•ä½œæˆ                                   â”‚
â”‚  â”‚         â†’ backend-dev ã¸                                     â”‚
â”‚  â”‚         "APIä»•æ§˜ã®ç¢ºèªãŠé¡˜ã„ã—ã¾ã™"                          â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 12:00  ğŸ“ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ                                  â”‚
â”‚  â”‚         ğŸ“‹ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚¿ã‚¹ã‚¯                                â”‚
â”‚  â”‚         "JWTèªè¨¼ã‚’æ¡ç”¨ã€æœ‰åŠ¹æœŸé™1æ™‚é–“"                       â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 10:15  ğŸ“‹ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢                                     â”‚
â”‚  â”‚         ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ done ã«å¤‰æ›´                             â”‚
â”‚  â”‚                                                               â”‚
â”‚  â”œâ”€ 10:00  ğŸ”Œ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹                                   â”‚
â”‚  â”‚         ãƒ„ãƒ¼ãƒ«: Claude Code                                  â”‚
â”‚  â”‚                                                               â”‚
â”‚  ğŸ“… æ˜¨æ—¥                                                        â”‚
â”‚  â”‚                                                               â”‚
â”‚  â””â”€ ...                                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›£æŸ»ãƒ­ã‚°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ECã‚µã‚¤ãƒˆé–‹ç™º - ç›£æŸ»ãƒ­ã‚°                     [ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  æœŸé–“: [2024-12-01 â–¼] ã€œ [2024-12-30 â–¼]                        â”‚
â”‚  ç¨®é¡: [ã™ã¹ã¦ â–¼]  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: [ã™ã¹ã¦ â–¼]                    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ æ—¥æ™‚     â”‚ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ â”‚ ç¨®é¡        â”‚ å¯¾è±¡       â”‚ å¤‰æ›´å†…å®¹    â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ 12/30   â”‚ frontend â”‚ status     â”‚ APIå®Ÿè£…    â”‚ progâ†’review â”‚â”‚
â”‚  â”‚ 14:30   â”‚          â”‚            â”‚           â”‚             â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ 12/30   â”‚ owner    â”‚ assigned   â”‚ DBè¨­è¨ˆ     â”‚ â†’backend   â”‚â”‚
â”‚  â”‚ 10:00   â”‚          â”‚            â”‚           â”‚             â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ 12/29   â”‚ backend  â”‚ handoff    â”‚ APIä»•æ§˜    â”‚ â†’frontend  â”‚â”‚
â”‚  â”‚ 16:45   â”‚          â”‚            â”‚           â”‚             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  1-50 / 234 ä»¶                          [<] [1] [2] [3] ... [>] â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## çŠ¶æ…‹å¾©å…ƒ

### ä»»æ„æ™‚ç‚¹ã®çŠ¶æ…‹å–å¾—

```swift
// 2024-12-29 12:00 æ™‚ç‚¹ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ã‚’å–å¾—
let taskState = try await historyRepository.reconstructState<Task>(
    entityType: .task,
    entityId: "tsk_xyz789",
    at: Date(iso8601: "2024-12-29T12:00:00Z")
)

// çµæœ: ãã®æ™‚ç‚¹ã§ã®ã‚¿ã‚¹ã‚¯ã®å®Œå…¨ãªçŠ¶æ…‹
// status: "todo", assignee: nil, priority: "medium", ...
```

### å¾©å…ƒã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```
1. å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆ (created) ã‚’å–å¾—
2. åˆæœŸçŠ¶æ…‹ã‚’æ§‹ç¯‰
3. æŒ‡å®šæ™‚ç‚¹ã¾ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«é©ç”¨
4. æœ€çµ‚çŠ¶æ…‹ã‚’è¿”å´

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  Event 1      Event 2      Event 3      Event 4                 â”‚
â”‚  (created)    (updated)    (updated)    (updated)               â”‚
â”‚     â”‚            â”‚            â”‚            â”‚                    â”‚
â”‚     â–¼            â–¼            â–¼            â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ S0  â”‚ â”€â”€â†’ â”‚ S1  â”‚ â”€â”€â†’ â”‚ S2  â”‚ â”€â”€â†’ â”‚ S3  â”‚  ç¾åœ¨            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                             â†‘                                   â”‚
â”‚                        æŒ‡å®šæ™‚ç‚¹ã§å¾©å…ƒ                           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæœ€é©åŒ–

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€å®šæœŸçš„ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜:

```sql
CREATE TABLE entity_snapshots (
    id TEXT PRIMARY KEY,
    entity_type TEXT NOT NULL,
    entity_id TEXT NOT NULL,
    state JSON NOT NULL,              -- ãã®æ™‚ç‚¹ã®å®Œå…¨ãªçŠ¶æ…‹
    event_id TEXT NOT NULL,           -- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ™‚ç‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆID
    timestamp TEXT NOT NULL,

    FOREIGN KEY (event_id) REFERENCES state_change_events(id)
);

CREATE INDEX idx_snapshots_entity ON entity_snapshots(entity_type, entity_id, timestamp);
```

```
å¾©å…ƒæ™‚:
1. æŒ‡å®šæ™‚ç‚¹ã‚ˆã‚Šå‰ã®æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
2. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä»¥é™ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ã‚’é©ç”¨
3. å¾©å…ƒæ™‚é–“ã‚’å¤§å¹…çŸ­ç¸® (O(n) â†’ O(k), k << n)
```

---

## ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²ã®å®Ÿè£…

### è‡ªå‹•è¨˜éŒ²ã®ãŸã‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

```swift
// UseCaseå±¤ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’è‡ªå‹•è¨˜éŒ²
final class UpdateTaskStatusUseCase {
    private let taskRepository: TaskRepository
    private let historyRepository: StateHistoryRepository
    private let sessionContext: SessionContext

    func execute(
        taskId: TaskID,
        newStatus: TaskStatus,
        reason: String?
    ) async throws -> Task {
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
        let task = try await taskRepository.get(taskId)
        let oldStatus = task.status

        // çŠ¶æ…‹ã‚’æ›´æ–°
        var updatedTask = task
        updatedTask.status = newStatus
        try await taskRepository.save(updatedTask)

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
        let event = StateChangeEvent(
            id: EventID.generate(),
            entityType: .task,
            entityId: taskId.value,
            eventType: .statusChanged,
            changes: [
                FieldChange(
                    field: "status",
                    oldValue: oldStatus.rawValue,
                    newValue: newStatus.rawValue
                )
            ],
            actorId: sessionContext.currentAgentId,
            sessionId: sessionContext.currentSessionId,
            reason: reason,
            metadata: nil,
            timestamp: Date()
        )
        try await historyRepository.recordEvent(event)

        return updatedTask
    }
}
```

### MCPçµŒç”±ã®è¨˜éŒ²

```swift
// MCPã‚µãƒ¼ãƒãƒ¼å´ã§ã®å®Ÿè£…
func handleUpdateTaskStatus(params: UpdateTaskStatusParams) async throws -> Task {
    // sessionContext ã¯MCPæ¥ç¶šæ™‚ã«è¨­å®šæ¸ˆã¿
    return try await updateTaskStatusUseCase.execute(
        taskId: TaskID(params.taskId),
        newStatus: TaskStatus(rawValue: params.status)!,
        reason: params.reason
    )
}
```

---

## ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼

### ä¿æŒæœŸé–“

| ãƒ‡ãƒ¼ã‚¿ç¨®é¡ | ä¿æŒæœŸé–“ | ç†ç”± |
|-----------|---------|------|
| çŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ | ç„¡æœŸé™ | å®Œå…¨ãªç›£æŸ»è¨¼è·¡ |
| ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ | 1å¹´ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç”¨ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°è©³ç´° | 90æ—¥ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡ |

### ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æˆ¦ç•¥

```
Active DB (SQLite)
    â†“ 90æ—¥çµŒé
Archive DB (SQLite, åœ§ç¸®)
    â†“ å¿…è¦ã«å¿œã˜ã¦
Export (JSON/CSV)
```

### GDPR/ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å¯¾å¿œ

```swift
// ç‰¹å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å±¥æ­´ã‚’åŒ¿ååŒ–
func anonymizeAgentHistory(agentId: AgentID) async throws {
    // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã‚’åŒ¿ååŒ–
    // actor_id ã‚’ "anonymized_xxx" ã«ç½®æ›
    // å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã‚’ãƒã‚¹ã‚¯
}
```

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|----------|
| 2024-12-30 | 1.0.0 | åˆç‰ˆä½œæˆ |
