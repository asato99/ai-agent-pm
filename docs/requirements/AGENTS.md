# エージェント (Agent) 仕様

## 定義
アプリ内で権限や役割を割り当てられる存在。
AI（Claude Code, Gemini等）や人間を区別なく扱う抽象概念。

## 属性
| 属性 | 説明 |
|------|------|
| 名前 | エージェントの識別名 |
| 種別 (type) | AI / 人間 |
| 階層タイプ (hierarchyType) | Manager / Worker |
| 紐付け先 | AI種別（Claude, Gemini等）または人間の識別子 |
| 役割タイプ (roleType) | 担当領域（developer, reviewer, tester, architect, manager, writer, designer, analyst） |
| 役割 (role) | 自由記述の役割説明 |
| 権限 | 操作可能な範囲 |
| 並列実行可能数 | 同時に in_progress にできるタスク数 |
| 下位エージェント | Managerのみ: 管理対象のエージェントリスト |

### 属性の区別

| 属性 | 用途 | 値の例 |
|------|------|--------|
| **種別 (type)** | AIか人間かの区別 | `ai`, `human` |
| **階層タイプ (hierarchyType)** | タスク作成・割り当て権限 | `manager`, `worker` |
| **役割タイプ (roleType)** | 担当領域の分類 | `developer`, `manager`※ |

※ `roleType.manager` は「マネジメント担当」という役割分類であり、`hierarchyType.manager`（タスク作成権限）とは異なる

---

## エージェントタイプ

### Manager（マネージャー）

**役割**: タスクの作成・管理と下位エージェントへの割り当て

| 項目 | 内容 |
|------|------|
| タスク作成 | ○ 可能 |
| タスク割り当て | ○ 下位エージェントに割り当て可能 |
| タスク実行 | ✕ 自身では作業しない |
| 下位エージェント | ○ 保持可能 |

```
[Manager]
 ├─ タスク作成
 ├─ 下位エージェントへ割り当て
 └─ 進捗管理・報告受領
```

### Worker（ワーカー）

**役割**: 自身に割り当てられたタスクの実行

| 項目 | 内容 |
|------|------|
| タスク作成 | ✕ 不可（自分のタスクへのサブタスク追加は将来検討） |
| タスク割り当て | ✕ 自分自身のみ |
| タスク実行 | ○ 作業を行う |
| 下位エージェント | ✕ 保持しない |

```
[Worker]
 ├─ 割り当てられたタスクを実行
 └─ 完了/失敗を上位に報告
```

### タイプ比較

| 機能 | Manager | Worker |
|------|---------|--------|
| タスク作成 | ○ | ✕ |
| 他者への割り当て | ○ | ✕ |
| タスク実行 | ✕ | ○ |
| 下位エージェント | ○ | ✕ |

---

## エージェント間の依存関係

### 構造
- **ツリー構造**（上下関係）
- 親エージェント（上位） → 子エージェント（下位）

### 上位エージェントの責務
1. **タスクのアサイン**: 下位エージェントにタスクを割り当てる
2. **活動のキック**: 下位エージェントの作業を開始させる（トリガー）
3. **報告の受領**: 下位エージェントからの完了/失敗報告を受け取る

### 下位エージェントの責務
1. **タスクの実行**: アサインされたタスクを遂行
2. **報告**: タスクの完了または失敗を上位エージェントに報告

```
[上位エージェント]
    │
    ├── タスクアサイン ──→ [下位エージェント]
    │                           │
    ├── 活動キック ────→        │
    │                           │
    ←── 完了/失敗報告 ─────────┘
```

---

## 活動のキック

### 概要
タスクのステータスが `in_progress` に変更されたタイミングで、
アサインされたエージェントの実行を開始させる仕組み。

### トリガー条件
```
タスクステータス変更: * → in_progress
  ↓
assigneeId が設定されている
  ↓
エージェントのキックスクリプトを実行
```

### 実装方式

| 方式 | 対象 | 実行コマンド例 |
|------|------|---------------|
| CLIヘッドレス起動 | Claude Code | `claude --headless --agent-id={id}` |
| スクリプト実行 | カスタム | エージェント設定で定義したスクリプト |
| API呼び出し | Gemini等 | 各AIのAPI経由 |
| 通知 | 人間 | メール/Slack/Webhook |

### エージェント管理画面での設定

```
[エージェント設定]
├── 基本情報（名前、種別、役割）
├── 実行設定
│   ├── 起動方式: CLI / Script / API / Notification
│   ├── 起動コマンド/スクリプトパス
│   └── 環境変数（オプション）
└── 認証設定
    ├── エージェントID（自動生成）
    └── パスキー（オプション）
```

### 状態確認
- 上位エージェント自身がMCP経由で下位の状態を確認可能
- 下位からの能動的な報告は必須ではない

---

## エージェント認証

### 目的
エージェントがMCP経由でシステムに接続する際、
正しいエージェントとして紐付けられることを保証する。

### 認証フロー

```
[エージェント起動]
  ↓
MCP接続時に認証情報を送信
  - agent_id: 必須
  - passkey: オプション（設定時は必須）
  ↓
[システム側で検証]
  - agent_id の存在確認
  - passkey の一致確認（設定されている場合）
  ↓
認証成功 → セッション開始
認証失敗 → 接続拒否
```

### 認証レベル

| レベル | 認証方式 | 用途 |
|--------|----------|------|
| Level 0 | agent_id のみ | 開発/テスト環境 |
| Level 1 | agent_id + passkey | 本番環境（推奨） |
| Level 2 | agent_id + passkey + IP制限 | セキュア環境（将来） |

### エージェント属性（追加）

| 属性 | 説明 |
|------|------|
| passkey | 認証用の秘密鍵（ハッシュ保存） |
| auth_level | 認証レベル (0/1/2) |
| allowed_ips | 許可IPリスト（Level 2用、将来） |

### 初期実装

1. **Phase 1**: agent_id のみで認証（開発優先）
2. **Phase 2**: passkey 対応追加
3. **Phase 3**: IP制限等のセキュリティ強化

### MCP接続時の認証例

```json
{
  "method": "authenticate",
  "params": {
    "agent_id": "agent_abc123",
    "passkey": "secret_key_here"
  }
}
```

### 認証失敗時の動作
- エラーログに記録
- 接続を即座に切断
- 上位エージェント/管理者に通知（オプション）

---

## 依存関係の構造

- **初期実装**: ツリー構造（単一の親）
- **将来検討**: DAG（複数の親）も視野に

---

## プロジェクト参加

- 1エージェントが複数プロジェクトに参加可能

---

## リソース可用性

### 初期実装
- **並列実行可能数**をエージェントごとに設定
- in_progress 状態のタスク数が上限に達したらロック

```
例:
  エージェントA: 並列数 = 1 → 1タスクのみ in_progress 可
  エージェントB: 並列数 = 3 → 3タスクまで同時 in_progress 可
```

### ロックの動作
- in_progress への状態変更時にチェック
- 上限到達時は状態変更をブロック

### 将来検討
- タスクの重さ・種類による制御
- 実際の処理状態（待ち/実行中）の反映
- 稼働時間帯の設定（人間向け）
