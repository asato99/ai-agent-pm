# タスク (Task) 仕様

## 定義
エージェントが行うすべての行動を可視化・管理する単位。

## 基本原則
- エージェントの全行動をタスクとして管理
- 自分自身へのアサインも可能（セルフアサイン）
- 他エージェントへのアサインも可能（上位→下位）

---

## 属性
| 属性 | 説明 |
|------|------|
| タイトル | タスクの概要 |
| 説明 | 詳細な内容 |
| 状態 | 現在のステータス |
| アサイン先 | 担当エージェント |
| 作成者 | タスクを作成したエージェント |
| 依存タスク | 先行して完了すべきタスク群 |
| 優先度 | urgent / high / medium / low |

---

## 状態遷移

```
backlog → todo → in_progress → done
                      ↓
                  cancelled
```

| 状態 | 説明 |
|------|------|
| backlog | 未着手（いつかやる） |
| todo | 着手予定（次にやる） |
| in_progress | 作業中 |
| done | 完了 |
| cancelled | 破棄（履歴として残る） |

### cancelled について
- 履歴管理上、削除ではなく状態として残す
- エージェントの行動判断に影響（破棄されたタスクは着手しない）
- 破棄理由も記録すべき？

### 状態遷移の制限

**許可される遷移:**
```
backlog → todo → in_progress → done
   ↓        ↓         ↓
   └────────┴─────────┴────→ cancelled
                ↓
            blocked ←→ in_progress
```

**制限される遷移（in_progress以降）:**

| 現在の状態 | 禁止される遷移 | 理由 |
|-----------|--------------|------|
| in_progress | → todo | ExecutionLog作成済み、作業コンテキスト破棄 |
| in_progress | → backlog | 同上 |
| blocked | → todo | 作業履歴の整合性維持 |
| blocked | → backlog | 同上 |
| done | → 他の状態 | 完了済みの巻き戻し禁止 |
| cancelled | → 他の状態 | 破棄済みの復活禁止 |

**制限の背景:**
- `in_progress`への遷移時にExecutionLogが作成される
- エージェントが実際に作業を開始している可能性がある
- 単純なステータス巻き戻しは整合性の問題を引き起こす

**代替手段:**
- **キャンセル**: `cancelled`にして新規タスクを作成
- **ブロック**: `blocked`にして問題解決後に再開
- **ハンドオフ**: 別エージェントへの正式な委任（下記参照）

---

## 担当エージェントの変更（再割り当て）

### 基本ルール

| タスク状態 | 再割り当て | 理由 |
|-----------|:--------:|------|
| backlog | ✓ | 作業未開始 |
| todo | ✓ | 作業未開始 |
| in_progress | ✗ | ExecutionLog作成済み、作業中 |
| blocked | ✗ | 作業履歴あり |
| done | - | 完了済み |
| cancelled | - | 破棄済み |

### 制限時の代替手段

**in_progress/blockedタスクを別エージェントに渡したい場合:**

1. **ハンドオフを使用**（推奨）
   - 作業コンテキストを引き継いで委任
   - 元エージェントの作業履歴が保持される
   - 参照: docs/requirements/HANDOFF.md（将来）

2. **キャンセル→新規作成**
   - 現タスクを`cancelled`にする
   - 新しいタスクを作成して別エージェントに割り当て
   - コンテキストの明示的な引き継ぎが必要

3. **ブロック→問題解決**
   - 現タスクを`blocked`にする
   - 問題を解決してから同じエージェントが再開

### 実装上の考慮

**UIでの制御:**
- 再割り当てUIは`backlog`/`todo`のみ有効
- `in_progress`/`blocked`では再割り当てボタンを非活性化
- 警告メッセージで代替手段を案内

**MCPでの制御:**
- `assign_task`でステータスチェックを追加
- 制限違反時はエラーを返す

---

## タスク間の依存関係

### 構造
- **DAG（有向非巡回グラフ）** を想定
- 複数の先行タスクを持てる
- 循環依存は禁止

```
[タスクA] ──→ [タスクC] ──→ [タスクD]
[タスクB] ──↗
```

### 依存関係の遵守
- **アプリで強制ブロック**
- 先行タスクが done になるまで in_progress に移行不可
- MCP経由の状態変更もブロック対象

### リソース可用性の遵守
- **アプリで強制ブロック**
- アサイン先エージェントの並列実行可能数を超える場合、in_progress に移行不可

### 可視化
- 初期実装はシンプルに（依存先タスク名の表示程度）
- グラフ表示等は将来検討

---

## 設計方針

### サブタスク
- **初期実装では不要**
- 依存関係のみでタスク間の関係を表現
- 必要になれば後から追加

### タスクの粒度
- 主観的な「大きい/小さい」の区別はない
- 依存関係の設定で構造が決まる

### blocked状態
- **採用決定**: 依存タスク未完了時に blocked として表示
- in_progress への遷移がブロックされている状態を明示
- UIではBlockedカラムとして表示

---

## エージェント行動のタスク化

### 課題
エージェントの行動を自動的にタスクとして記録・管理する仕組みの設計が必要。

### 監査チーム構想
- プロジェクトチームとは独立した「監査チーム」エージェントグループ
- エージェントの行動がアプリ要件に合致するかを監視・強制
- 要件違反の検出と是正

```
[プロジェクトチーム]          [監査チーム]
 ├─ エージェントA               ├─ 監査エージェント
 ├─ エージェントB       ←監視─  └─ ...
 └─ エージェントC
        │
        └─ 行動 → タスク化 → 要件チェック
```

※ 詳細設計が必要な領域
