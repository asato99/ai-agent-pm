# UC005: マネージャー → ワーカー委任

## 概要

マネージャーエージェントがタスクを受け取り、サブタスクを作成してワーカーエージェントに委任。ワーカーはさらにサブタスクを作成して実行するフロー。

---

## 検証したいこと

1. **階層的タスク作成**: マネージャーがサブタスクを作成できる
2. **委任**: マネージャーが作成したサブタスクをワーカーに割り当てられる
3. **再帰的サブタスク**: ワーカーもサブタスクを作成できる
4. **完了伝播**: 子タスクの完了が親タスクの完了につながる

---

## フロー

```
タスク（親）
  │
  │ マネージャーが受け取る
  │ マネージャーがサブタスクを作成
  │ サブタスクをワーカーに割り当て
  ↓
サブタスク（assignee: ワーカー）
  │
  │ ワーカーが受け取る
  │ ワーカーがサブタスク（孫）を作成
  │ ワーカーが実行
  ↓
サブサブタスク（孫）
```

---

## 前提条件

- マネージャーエージェントが登録済み
- ワーカーエージェントが登録済み
- プロジェクトが存在（working_directory 設定済み）
- 親タスクが存在し、マネージャーに割り当て済み

---

## アクター

| アクター | 種別 | 役割 |
|----------|------|------|
| マネージャー | AI | タスクを分解し、サブタスクを作成してワーカーに委任 |
| ワーカー | AI | サブタスクを受け取り、必要に応じてさらに分解して実行 |

---

## 検証項目（アサーション）

### タスク階層の検証

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 1 | マネージャーがサブタスクを作成した | DBに親タスクを`parent_task_id`に持つタスクが存在 |
| 2 | サブタスクの`assignee_id`がワーカーである | DB: `tasks.assignee_id = ワーカーID` |
| 3 | ワーカーがサブサブタスクを作成した | DBにサブタスクを`parent_task_id`に持つタスクが存在 |

### 成果物の検証

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 4 | 成果物ファイルが生成された | `test -f <working_directory>/<成果物>` |

### ステータスの検証

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 5 | 親タスクのステータスが`done` | DB: `tasks.status = 'done'` |
| 6 | サブタスクのステータスが`done` | DB: `tasks.status = 'done'` |
| 7 | サブサブタスクのステータスが`done` | DB: `tasks.status = 'done'` |

---

## テストデータ

```
プロジェクト:
  - prj_uc005: UC005テスト用プロジェクト（working_dir: /tmp/uc005）

エージェント:
  - agt_uc005_manager: マネージャー
  - agt_uc005_worker: ワーカー

タスク（初期状態）:
  - tsk_uc005_parent: 親タスク（assignee: マネージャー、status: backlog）
```

---

## 成功条件

```
1. DBにサブタスクが存在する
   - parent_task_id = tsk_uc005_parent
   - assignee_id = agt_uc005_worker

2. DBにサブサブタスクが存在する
   - parent_task_id = (1で作成されたサブタスクのID)

3. 成果物ファイルが存在する

4. 全タスクのステータスが done
   - tsk_uc005_parent.status = done
   - サブタスク.status = done
   - サブサブタスク.status = done
```

---

## 関連ユースケース

| UC | 関係 |
|----|------|
| UC001 | 単一エージェントによるタスク実行（基本形） |
| UC002 | 複数エージェントが独立してタスク実行 |
| UC003 | AIタイプ切り替え |
| UC004 | 複数プロジェクト×同一エージェント |
| **UC005** | **マネージャー → ワーカー委任（本UC）** |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-10 | 初版作成（テスト仕様のみ） |
