# UC018: チャットからのタスク依頼

## 概要

人間エージェント（非上位者）がAIエージェントにチャットで作業を依頼し、上位の人間エージェントの承認を経てタスクが作成されるフロー。

---

## 前提条件

- 依頼者（人間エージェント）とWorker（AIエージェント）が同一プロジェクトに所属
- 承認者（人間エージェント）がWorkerの上位エージェントとして設定されている
- 依頼者とWorkerの間にチャットセッションが開かれている

---

## アクター

| アクター | 種別 | 階層 | 役割 |
|----------|------|------|------|
| 田中（PO） | human | - | 依頼者。機能要望を持っている |
| Worker-01 | ai | 佐藤の部下 | 作業者。実装を担当 |
| 佐藤（Tech Lead） | human | Worker-01の上位 | 承認者。作業の妥当性を判断 |

---

## 基本フロー

### Step 1: 依頼メッセージ送信（田中 → Worker-01）

```
田中 → Worker-01へチャットでメッセージ送信
  「ユーザー一覧画面に検索機能を追加してほしい」
```

**アサーション**: 田中のメッセージがチャットに表示される

---

### Step 2: 受付応答（Worker-01 → 田中）

```
Worker-01 → 田中へチャットで応答
  「承知しました。佐藤さんに承認を依頼します」
```

**アサーション**: Worker-01の応答メッセージがチャットに表示される

---

### Step 3: タスク依頼作成（Worker-01 → MCP）

```
Worker-01 → MCPツール request_task を実行
  - title: 「ユーザー一覧に検索機能追加」
  - description: 「名前・メールアドレスでの絞り込み機能を実装」
  - assignee_id: worker-01（自分自身）
  - priority: medium
    ↓
システム → タスクを作成
  - approval_status: pending_approval
  - requester_id: worker-01
  - 承認者: 佐藤（parent_agent_idから自動決定）
```

**アサーション**:
- タスクが作成される
- approval_status = `pending_approval`
- requester_id = `worker-01`

---

### Step 4: 承認者への通知（システム → 佐藤）

```
システム → 佐藤へシステムチャットで通知
  「Worker-01からタスク依頼があります: ユーザー一覧に検索機能追加」
```

**アサーション**: 佐藤のチャットにシステム通知メッセージが存在する

---

### Step 5: タスクボード表示確認（佐藤）

```
佐藤 → タスクボードを開く
    ↓
タスクボード表示:
  - 「承認待ち」バッジ付きのタスクカードが表示される
  - オレンジ背景で視覚的に区別される
```

**アサーション**:
- タスクボードに該当タスクが表示される
- 「🔔 承認待ち」バッジが表示される

---

## シーケンス図

```
田中        Worker-01       MCP Server      System         佐藤
  |             |               |             |              |
  |--チャット-->|               |             |              |
  | 「検索機能  |               |             |              |
  |  追加して」 |               |             |              |
  |             |               |             |              |
  |<--チャット--|               |             |              |
  | 「承知。    |               |             |              |
  |  承認依頼」 |               |             |              |
  |             |               |             |              |
  |             |--request_task>|             |              |
  |             |               |--タスク作成>|              |
  |             |               |  pending_   |              |
  |             |               |  approval   |              |
  |             |<--success-----|             |              |
  |             |               |             |              |
  |             |               |             |--システム--->|
  |             |               |             |  チャット    |
  |             |               |             |              |
  |             |               |             |              |--タスクボード
  |             |               |             |              |  確認
  |             |               |             |              |
```

---

## データフロー

### タスク作成時のデータ

| フィールド | 値 | 決定方法 |
|-----------|-----|---------|
| title | 「ユーザー一覧に検索機能追加」 | Worker-01が指定 |
| description | 「名前・メールアドレスでの絞り込み」 | Worker-01が指定 |
| assignee_id | worker-01 | Worker-01が指定（自己アサイン） |
| requester_id | worker-01 | request_task呼び出し元 |
| approval_status | pending_approval | システムが自動設定 |
| 承認者 | 佐藤 | Worker-01のparent_agent_idから自動決定 |

---

## システムチャット通知

### 通知メッセージ形式

```
送信者: system
受信者: 佐藤（承認者）
種別: task_request_notification
内容: 「Worker-01からタスク依頼があります: ユーザー一覧に検索機能追加」
関連タスクID: [作成されたタスクのID]
```

---

## 検証ポイントまとめ

| Step | 検証内容 |
|------|---------|
| 1 | 田中のメッセージがチャットに表示される |
| 2 | Worker-01の応答がチャットに表示される |
| 3 | タスクが `pending_approval` 状態で作成される |
| 4 | 佐藤にシステムチャット通知が届く |
| 5 | タスクボードに「承認待ち」バッジ付きタスクが表示される |

---

## 関連ユースケース

| UC | 関係 |
|----|------|
| UC017: タスク承認フロー | 本UCの後続。佐藤がタスクを承認/却下する |
| UC012: メッセージ送信 | Step 1, 2のチャット機能 |
| UC013: メッセージ受信 | Step 4のシステム通知 |

---

## 備考

- 依頼者（田中）は承認フローに直接関与しない
- 承認者は Worker-01 の階層関係（parent_agent_id）から自動決定される
- システムチャットは通常のチャットと区別できる形式で表示される
- 承認後のフローはUC017に準じる
