# UC007: 依存関係のあるタスク実行（生成→計算）

## 概要

マネージャーエージェントが2人のワーカーに対して、**依存関係のあるタスク**を割り当てる。生成担当ワーカーが完了した後に、計算担当ワーカーが実行されるフロー。

**UC006との違い**:
- UC006: 並列実行（日本語翻訳 || 中国語翻訳）
- UC007: 逐次実行（生成 → 計算）※依存関係あり

**厳密性のポイント**:
- 生成タスクが**乱数**を生成するため、計算タスクは事前に結果を知り得ない
- 計算タスクは生成タスクの出力ファイルを**読み込まないと処理できない**
- これにより、依存関係が正しく機能していることを厳密に検証できる

---

## 検証したいこと

1. **依存関係の設定**: マネージャーがタスク間の依存関係をDB上で正しく設定する
2. **逐次実行**: 生成タスク完了後に計算タスクが開始される
3. **成果物の参照**: 計算担当が生成担当の成果物を使用している
4. **結果の整合性**: `seed.txt の値 × 2 == result.txt の値`

---

## フロー

```
親タスク「乱数を生成し、その2倍を計算せよ」
  │
  │ マネージャーが受け取る
  │ マネージャーがサブタスクを作成（依存関係付き）
  │
  ↓
サブタスク A（生成、assignee: agt_uc007_generator）
  │ → seed.txt に乱数を書く
  │ → status: done
  │
  ↓ （Aの完了を待って開始）
サブタスク B（計算、assignee: agt_uc007_calculator、dependencies: [A]）
  │ → seed.txt を読み込み
  │ → 2倍にして result.txt に書く
  │ → status: done
```

---

## 前提条件

- マネージャーエージェントが登録済み
- 生成担当ワーカーエージェントが登録済み
- 計算担当ワーカーエージェントが登録済み
- プロジェクトが存在（working_directory: /tmp/uc007）
- 親タスクが存在し、マネージャーに割り当て済み

---

## アクター

| アクター | 種別 | ID | 役割 |
|----------|------|-----|------|
| マネージャー | AI | agt_uc007_manager | タスクを分解し、依存関係を設定してワーカーに割り当て |
| 生成担当 | AI | agt_uc007_generator | 乱数を生成してファイルに書き込む |
| 計算担当 | AI | agt_uc007_calculator | 入力ファイルを読み込み、計算結果を出力 |

---

## タスク要件

### 生成タスク

**タイトル**: `乱数を生成`

**要件**:
```
Pythonで1〜1000の乱数を生成し、/tmp/uc007/seed.txt に書いてください。

具体的な手順:
1. random.randint(1, 1000) で乱数を生成
2. その数値だけを /tmp/uc007/seed.txt に書く（改行なし）
```

**期待する成果物**: `/tmp/uc007/seed.txt`（1〜1000の整数が1つ）

### 計算タスク

**タイトル**: `2倍を計算`

**要件**:
```
/tmp/uc007/seed.txt を読み込み、その値を2倍にして /tmp/uc007/result.txt に書いてください。

具体的な手順:
1. /tmp/uc007/seed.txt を読み込む
2. その値を整数として解釈
3. 2倍にした値を /tmp/uc007/result.txt に書く（改行なし）
```

**依存**: 生成タスクの完了後に実行（dependencies に生成タスクIDを設定）

**期待する成果物**: `/tmp/uc007/result.txt`（seed.txt の値 × 2）

---

## 検証項目（アサーション）

### タスク割り当ての検証

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 1 | マネージャーがサブタスクを2つ作成した | DBに親タスクを`parent_task_id`に持つタスクが2つ存在 |
| 2 | 生成タスクが生成担当に割り当てられた | DB: 生成関連タスクの`assignee_id = agt_uc007_generator` |
| 3 | 計算タスクが計算担当に割り当てられた | DB: 計算関連タスクの`assignee_id = agt_uc007_calculator` |

### 依存関係の検証（厳密）

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 4 | 計算タスクが生成タスクに依存している | **DB: 計算タスクの`dependencies`フィールドに生成タスクIDが含まれる** |

### 成果物の検証

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 5 | seed.txt が生成された | `test -f /tmp/uc007/seed.txt` |
| 6 | result.txt が生成された | `test -f /tmp/uc007/result.txt` |

### 結果の整合性検証（厳密）

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 7 | 計算結果が正しい | `seed.txt の値 × 2 == result.txt の値` |

### 実行順序の検証

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 8 | 生成タスクが計算タスクより先に完了した | ファイルタイムスタンプ: seed.txt < result.txt |

### ステータスの検証

| # | 検証内容 | 確認方法 |
|---|----------|----------|
| 9 | 全タスクのステータスが`done` | DB: 親タスク + 全サブタスクの`status = 'done'` |

---

## テストデータ

```
プロジェクト:
  - prj_uc007: UC007テスト用プロジェクト（working_dir: /tmp/uc007）

エージェント:
  - agt_uc007_manager: マネージャー（hierarchy_type: manager）
  - agt_uc007_generator: 生成担当（hierarchy_type: worker）
  - agt_uc007_calculator: 計算担当（hierarchy_type: worker）

タスク（初期状態）:
  - tsk_uc007_main: 親タスク（assignee: マネージャー、status: backlog）
    title: "乱数を生成し、その2倍を計算せよ"
    description: |
      以下の作業を2つのサブタスクに分けて実行してください:

      1. 生成タスク: random.randint(1, 1000) で乱数を生成し /tmp/uc007/seed.txt に書く
      2. 計算タスク: seed.txt を読み込み、2倍にして /tmp/uc007/result.txt に書く

      重要: 計算タスクは生成タスクに依存します。dependencies パラメータで依存関係を設定してください。
```

---

## 成功条件

```
1. DBにサブタスクが2つ存在する
   - parent_task_id = tsk_uc007_main

2. 生成タスクが生成担当に割り当てられている
   - タスクのtitleまたはdescriptionに「生成」「seed」「乱数」を含む
   - assignee_id = agt_uc007_generator

3. 計算タスクが計算担当に割り当てられている
   - タスクのtitleまたはdescriptionに「計算」「2倍」「result」を含む
   - assignee_id = agt_uc007_calculator

4. 【厳密】計算タスクのdependenciesに生成タスクIDが含まれている
   - DB: dependencies カラム（JSON配列）に生成タスクIDが存在

5. 成果物ファイルが存在する
   - /tmp/uc007/seed.txt
   - /tmp/uc007/result.txt

6. 【厳密】結果の整合性
   - seed.txt の値 × 2 == result.txt の値

7. 実行順序が正しい
   - seed.txt のタイムスタンプ < result.txt のタイムスタンプ

8. 全タスクのステータスが done
   - tsk_uc007_main.status = done
   - 全サブタスク.status = done
```

---

## 技術的考慮事項

### 依存関係の実装方法

1. **create_task ツールに dependencies パラメータを追加**
2. **タスク作成時に dependencies: [generator_task_id] を設定**
3. **should_start APIで依存タスクが完了しているか確認**

### Coordinatorの動作

```
1. マネージャーがサブタスクを作成
   - 生成タスク（dependencies: []）
   - 計算タスク（dependencies: [生成タスクID]）
2. Coordinatorがポーリング
3. should_start(generator_worker) → True（依存なし）
4. 生成ワーカーが実行開始 → seed.txt 作成 → done
5. should_start(calculator_worker) → True（依存タスク完了）
6. 計算ワーカーが実行開始 → seed.txt 読込 → result.txt 作成 → done
```

---

## 関連ユースケース

| UC | 関係 |
|----|------|
| UC005 | マネージャー → 単一ワーカー委任 |
| UC006 | マネージャー → 複数ワーカー並列割り当て |
| **UC007** | **マネージャー → 複数ワーカー依存実行（本UC）** |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-10 | 初版作成（実装→テスト） |
| 2026-01-10 | 再設計：生成→計算の厳密な依存関係テストに変更 |
