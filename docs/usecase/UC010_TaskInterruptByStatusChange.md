# UC: タスク実行中にステータスを「blocked」に変更

## 概要

ユーザーがWeb UIからタスクのステータスを「blocked」に変更した際、実行中のエージェントに通知し、作業を中断させる。

## アクター

- ユーザー（Web UI操作）
- エージェント（タスク実行中）

## 前提条件

- タスクのステータスが `in_progress`
- エージェントが当該タスクを実行中

## トリガー

ユーザーがWeb UIでタスクのステータスを `blocked` に変更

## 基本フロー

| # | アクター | アクション |
|---|----------|------------|
| 1 | ユーザー | Web UIでタスクのステータスを `blocked` に変更 |
| 2 | システム | タスクのステータスを更新 |
| 3 | システム | 対象エージェントへの通知レコードを作成 |
| 4 | エージェント | 任意のMCPツールを呼び出す |
| 5 | システム | レスポンスに通知ありのメッセージを含める |
| 6 | エージェント | `get_notifications` を呼び出す |
| 7 | システム | 通知詳細を返却 |
| 8 | エージェント | 作業を中断 |
| 9 | エージェント | `report_completed` を `result='blocked'` で呼び出す |
| 10 | システム | タスク完了を記録、通知をクリア |

## シーケンス図

```
ユーザー          REST API           MCPServer          エージェント
   │                 │                   │                   │
   │ blocked に変更  │                   │                   │
   ├────────────────>│                   │                   │
   │                 │                   │                   │
   │                 │ ステータス更新     │                   │
   │                 │ 通知レコード作成   │                   │
   │                 │                   │                   │
   │                 │                   │<──────────────────│
   │                 │                   │ 任意のMCPツール    │
   │                 │                   │                   │
   │                 │                   │ 通知有無チェック   │
   │                 │                   ├──────────────────>│
   │                 │                   │ result +          │
   │                 │                   │ notification      │
   │                 │                   │                   │
   │                 │                   │<──────────────────│
   │                 │                   │ get_notifications │
   │                 │                   │                   │
   │                 │                   │ 通知詳細返却       │
   │                 │                   ├──────────────────>│
   │                 │                   │                   │
   │                 │                   │<──────────────────│
   │                 │                   │ report_completed  │
   │                 │                   │ (result=blocked)  │
   │                 │                   │                   │
   │                 │                   │ 完了処理          │
   │                 │                   │                   │
```

## 通知内容

### notification フィールド（全MCPレスポンス）

```
"通知があります。get_notificationsを呼び出して確認してください。"
```

### get_notifications レスポンス

```json
{
  "notifications": [
    {
      "type": "status_change",
      "action": "blocked",
      "task_id": "task-xxx",
      "message": "タスクのステータスがblockedに変更されました",
      "instruction": "作業を中断し、report_completedをresult='blocked'で呼び出してください"
    }
  ]
}
```

## 事後条件

- タスクのステータスが `blocked`
- エージェントの実行が完了
- 通知レコードがクリア済み

## 例外フロー

| # | 条件 | 対応 |
|---|------|------|
| 4a | エージェントがMCPツールを呼び出さない | 通知は保持され、次回呼び出し時に検知 |
| 6a | エージェントが `get_notifications` を呼び出さない | 次回のMCPツール呼び出しで再度通知 |
