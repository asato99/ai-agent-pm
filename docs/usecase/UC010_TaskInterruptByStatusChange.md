# UC: タスク実行中にステータスを「blocked」に変更

## 概要

ユーザーがWeb UIからタスクのステータスを「blocked」に変更した際、実行中のエージェントに通知し、作業を中断させる。

## アクター

- ユーザー（Web UI操作）
- エージェント（タスク実行中）

## 前提条件

- タスクのステータスが `in_progress`
- エージェントが当該タスクを実行中

## トリガー

ユーザーがWeb UIでタスクのステータスを `blocked` に変更

## 基本フロー

| # | アクター | アクション |
|---|----------|------------|
| 1 | ユーザー | Web UIでタスクのステータスを `blocked` に変更 |
| 2 | システム | タスクのステータスを更新 |
| 3 | システム | 対象エージェントへのinterrupt通知レコードを作成 |
| 4 | エージェント | 任意のMCPツールを呼び出す |
| 5 | システム | **レスポンスを通知メッセージに完全に差し替え**（本来の結果は返さない） |
| 6 | エージェント | `get_notifications` を呼び出す |
| 7 | システム | 通知詳細を返却、通知を既読化 |
| 8 | エージェント | 作業を中断 |
| 9 | エージェント | `report_completed` を `result='blocked'` で呼び出す |
| 10 | システム | タスク完了を記録 |

> **重要**: ステップ5でレスポンスを完全に差し替えることで、エージェントは通知に対応せざるを得なくなる。単にフィールドを追加するだけでは、エージェントが見落とす可能性がある。

## シーケンス図

```
ユーザー          REST API           MCPServer          エージェント
   │                 │                   │                   │
   │ blocked に変更  │                   │                   │
   ├────────────────>│                   │                   │
   │                 │                   │                   │
   │                 │ ステータス更新     │                   │
   │                 │ interrupt通知作成 │                   │
   │                 │                   │                   │
   │                 │                   │<──────────────────│
   │                 │                   │ 任意のMCPツール    │
   │                 │                   │                   │
   │                 │                   │ interrupt通知検出 │
   │                 │                   ├──────────────────>│
   │                 │                   │ 通知メッセージ     │
   │                 │                   │ （結果は差替え）   │
   │                 │                   │                   │
   │                 │                   │<──────────────────│
   │                 │                   │ get_notifications │
   │                 │                   │                   │
   │                 │                   │ 通知詳細返却       │
   │                 │                   │ ＋既読化          │
   │                 │                   ├──────────────────>│
   │                 │                   │                   │
   │                 │                   │<──────────────────│
   │                 │                   │ report_completed  │
   │                 │                   │ (result=blocked)  │
   │                 │                   │                   │
   │                 │                   │ 完了処理          │
   │                 │                   │                   │
```

## 通知内容

### interrupt通知時のレスポンス（差替え）

ツールの戻り値が以下のメッセージに完全に差し替えられる:

```
通知があります。

1. get_notifications() を呼び出して詳細を確認してください
2. 通知の指示に従ってください
```

### get_notifications レスポンス

```json
{
  "notifications": [
    {
      "id": "notif-xxx",
      "type": "interrupt",
      "action": "blocked",
      "task_id": "task-xxx",
      "message": "タスクのステータスがblockedに変更されました",
      "instruction": "作業を中断し、report_completedをresult='blocked'で呼び出してください"
    }
  ],
  "notification": "通知はありません"
}
```

> 注: get_notifications呼び出し時に通知は自動で既読化される

## 事後条件

- タスクのステータスが `blocked`
- エージェントの実行が完了
- 通知レコードがクリア済み

## 例外フロー

| # | 条件 | 対応 |
|---|------|------|
| 4a | エージェントがMCPツールを呼び出さない | 通知は保持され、次回呼び出し時に検知 |
| 6a | エージェントが `get_notifications` を呼び出さない | 次回のMCPツール呼び出しで再度通知（レスポンス差替え） |

---

## 実装状況

**ステータス**: 実装完了・テスト済み

### 統合テスト

- テストファイル: `web-ui/e2e/integration/task-interrupt.spec.ts`
- 実行スクリプト: `web-ui/e2e/integration/run-uc010-test.sh`
- 検証閾値: 60秒以内にエージェントが中断を検知

### 実装箇所

- 通知ミドルウェア: `Sources/MCPServer/MCPServer.swift:289`
- interrupt通知レスポンス差替え: 同上
- get_notificationsツール: `Sources/MCPServer/MCPServer.swift`
