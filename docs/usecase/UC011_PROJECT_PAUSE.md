# UC011: プロジェクト一時停止 テスト設計

## 概要

プロジェクト一時停止機能（Feature 14）の統合テスト設計。

**要件ドキュメント**: `docs/plan/PROJECT_PAUSE_FEATURE.md`

---

## テストシナリオ

設計ドキュメントのテスト観点に基づき、以下のシナリオをテストする。

### シナリオ1: 実行中エージェントへのexit指示（最重要）

**目的**: 実行中のエージェントがMCPツール呼び出し時にexit指示を受けることを検証

**前提条件**:
- プロジェクトがactive状態
- タスクがin_progress状態
- エージェントが実行中（InstanceBadgeが「実行中」）

**フロー**:
```
1. タスクをin_progressに変更
2. エージェントが起動し「実行中」状態になるのを待機
3. プロジェクトを一時停止
4. エージェントが次のMCPツール呼び出し時にexit指示を受ける
5. エージェントがlogoutしてセッションが終了
6. InstanceBadgeが「待機中」になることを確認
```

**検証ポイント**:
- エージェントが「実行中」状態であることを確認してから一時停止
- 一時停止後、エージェントが停止すること
- セッションがクリーンアップされること

**難易度**: 高（タイミング依存）

### シナリオ2: 新規エージェント起動のブロック

**目的**: 一時停止中はget_agent_actionがholdを返し、新規起動が行われないことを検証

**前提条件**:
- プロジェクトがpaused状態
- タスクがtodo状態（まだ開始されていない）

**フロー**:
```
1. プロジェクトを一時停止
2. タスクをin_progressに変更
3. 一定時間待機
4. エージェントが起動されないことを確認（ファイル未作成等）
```

**検証ポイント**:
- paused状態ではget_agent_actionがhold（reason: project_paused）を返す
- 新規エージェントが起動されない

**難易度**: 低（タイミング非依存）

### シナリオ3: 再開後のタスク継続

**目的**: 再開後にin_progressタスクが正常に継続できることを検証

**前提条件**:
- プロジェクトがpaused状態
- タスクがin_progress状態で残っている

**フロー**:
```
1. プロジェクトを再開
2. エージェントが起動することを確認
3. タスクが完了することを確認
4. get_my_taskでresumed_from_pauseフラグが返されることを確認
```

**検証ポイント**:
- 再開後にタスクが継続される
- 復帰フラグが正しく設定される

**難易度**: 中

---

## テスト構成

### 統合テスト（XCUITest + Coordinator）

フレーキーテストを回避しつつ、実際のユースケースをテストする構成。

#### テスト1: 完全フロー（シナリオ1→3の組み合わせ）

```
Phase 1: タスク開始
  - タスクをin_progressに変更
  - エージェントが起動するのを待機（InstanceBadge: 実行中）
  - または、エージェントがファイル操作を開始するまで待機

Phase 2: 一時停止
  - プロジェクトを一時停止
  - エージェントが停止するのを待機
  - 検証: エージェントがexit指示を受けて停止した

Phase 3: 一時停止中の状態確認
  - タスクはin_progressのまま
  - セッションは無効化されている
  - 新規エージェントは起動されない

Phase 4: 再開
  - プロジェクトを再開
  - エージェントが再起動するのを待機

Phase 5: 完了確認
  - タスクが完了することを確認
  - ファイルが作成されることを確認
```

#### フレーキー回避策

**問題**: エージェントの実行速度によっては「実行中」状態を観測できない

**対策**:
1. **長時間タスクの使用**: タスク内容を「複数ファイル作成」など時間がかかるものにする
2. **ファイル作成監視**: 最初のファイルが作成されたら「実行中」と判断
3. **DBベースの検証**: InstanceBadgeではなくDB上のセッション状態を検証
4. **リトライ許容**: 「実行中」状態の検出に複数回トライを許容

**タスク設計例**:
```
タスク: 以下のファイルを順番に作成
1. /tmp/uc011_test/step1.md（開始マーカー）
2. /tmp/uc011_test/step2.md（10秒待機後）
3. /tmp/uc011_test/step3.md（10秒待機後）
4. /tmp/uc011_test/complete.md（完了マーカー）
```

このタスク設計により：
- step1.md作成 → エージェント実行中と判断
- step1.mdあり + complete.mdなし → 中断状態と判断
- complete.md作成 → タスク完了と判断

---

## 現在の実装の問題点

### 誤ったアプローチ: Pause-First

```
❌ 誤り: 先に一時停止 → タスク開始 → 起動されないことを確認
```

これは「シナリオ2: 新規エージェント起動のブロック」のみをテストしており、
最重要の「シナリオ1: 実行中エージェントへのexit指示」をテストしていない。

### 正しいアプローチ

```
✓ 正しい: タスク開始 → 実行中を確認 → 一時停止 → 停止を確認 → 再開 → 完了を確認
```

---

## 現在の実装状況

### 実装済み

- `testPauseResumeIntegration_RunningAgentStopsAndResumes`: タスク開始→一時停止→再開→完了フロー
- `testPauseBlocksNewAgentStart`: Pause-Firstアプローチ（シナリオ2）

### シナリオ1の問題点（要再検討）

**現在のテスト `testPauseResumeIntegration_RunningAgentStopsAndResumes` には以下の問題がある：**

1. **停止の検証が不十分**:
   - 「30秒待機してファイルが増えない」は間接的な検証
   - タスクが短時間で完了した場合、偽陽性になる
   - 警告を出すだけでXCTAssertで検証していない

2. **タイミング依存**:
   - LLMの実行速度に依存
   - 一時停止前にタスクが完了する可能性がある

3. **本質的なテスト不足**:
   - 「実行中エージェントがexit指示を受けて停止する」ことを検証していない
   - セッション状態の変化を確認していない

### 正しい検証に必要なこと

シナリオ1を正しくテストするには、以下のいずれかが必要：

1. **DBベースの検証**:
   - AgentSessionがinactive/terminatedになったことをDBで確認
   - MCPサーバー経由でセッション状態を取得

2. **Coordinatorログの検証**:
   - 「Instance stopped」ログを確認
   - exit指示が返されたことを確認

3. **長時間実行タスクの設計**:
   - エージェントが確実に一定時間実行中になるタスク
   - ただしLLMの挙動に依存するため信頼性に限界あり

### TODO

1. [ ] シナリオ1のテスト設計を再検討
2. [ ] DBベースの検証を検討（セッション状態確認）
3. [ ] 現在のテストはシナリオ2（新規起動ブロック）のみ信頼できることを明記

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-15 | 初版作成: テスト設計の明確化 |
| 2026-01-15 | シナリオ1の問題点を明記、要再検討として記録 |
