# UC015: チャットセッション終了

## 概要

ユーザーがチャットパネルを閉じた時に、チャットセッションを終了する。

## 関連ユースケース

- **UC014**: チャットセッション即時応答（セッション開始）

## アクター

- **Human**: チャットパネルを操作するユーザー
- **Worker**: チャット応答待機中のエージェント
- **System**: セッション管理システム

## 前提条件

1. ユーザーがログイン済み
2. チャットパネルが開いており、セッションがアクティブ（UC014完了状態）
3. エージェントがメッセージ待機中

## 基本フロー

1. ユーザーがチャットパネルの閉じるボタン（×）をクリックする
2. システムがチャットセッションの終了を記録する
3. チャットパネルが閉じる
4. エージェントがセッション終了を検知し、待機状態から抜ける
5. エージェントプロセスが終了する

## 代替フロー

### A1: ブラウザタブを直接閉じた場合

1. ユーザーがブラウザタブまたはウィンドウを閉じる
2. システムが可能な限りセッション終了を記録する
3. 記録できなかった場合、セッションタイムアウトにより自動終了する

### A2: 別のエージェントのチャットを開いた場合

1. ユーザーがAgent Aとのチャット中にAgent Bのアバターをクリック
2. Agent Aとのセッションが終了する
3. Agent Bとの新しいセッションが開始する（UC014）

### A3: プロジェクト画面から離れた場合

1. ユーザーがチャットパネルを開いたまま別のページに遷移する
2. セッションが終了する

## 例外フロー

### E1: ネットワークエラー

1. セッション終了の記録に失敗する
2. チャットパネルは閉じる（ユーザー操作を優先）
3. セッションはタイムアウトにより後で自動終了する

## 事後条件

1. チャットパネルが非表示になる
2. セッションが終了状態になる
3. エージェントが待機状態から解放される
4. システムリソースが解放される

## ビジネスルール

- セッション終了はユーザー操作を妨げない（エラーがあってもUIは閉じる）
- 終了できなかったセッションはタイムアウトで自動的にクリーンアップされる
- 同一ユーザーが同一エージェントに対して持てるアクティブセッションは1つのみ

## 備考

- セッション終了により、エージェントは他のタスク（タスク実行など）を受け付けられるようになる
- チャット履歴はセッション終了後も保持される（セッションとチャット履歴は独立）
