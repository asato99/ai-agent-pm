# UC008: タスクのブロックによる作業中断

## 概要

ユーザーが親タスクをブロック状態にすることで、関連するサブタスクと実行中のエージェントインスタンスを停止させる。

---

## 前提条件

- 親タスクが `in_progress` 状態である
- サブタスクが作成されている
- エージェントインスタンスがサブタスクを実行中である

---

## アクター

| アクター | 種別 | 役割 |
|----------|------|------|
| ユーザー | Human | 親タスクのブロック操作 |
| システム | System | サブタスクへのカスケード、エージェント停止 |
| ワーカーエージェント | AI | 停止対象 |

---

## 基本フロー

### 1. 初期状態

```
親タスク: in_progress
  └─ サブタスク1: in_progress (ワーカーA実行中)
  └─ サブタスク2: todo
  └─ サブタスク3: backlog
```

### 2. ブロック操作（ユーザー）

```
ユーザー → UIで親タスクのステータスを blocked に変更
```

### 3. カスケード処理（システム）

```
システム → サブタスクのステータスを自動的に blocked に変更
  - サブタスク1: in_progress → blocked
  - サブタスク2: todo → blocked
  - サブタスク3: backlog → blocked
```

### 4. エージェント停止（システム）

```
システム → 実行中のエージェントインスタンスを停止
  - ワーカーA: 停止
```

### 5. 結果状態

```
親タスク: blocked
  └─ サブタスク1: blocked (ワーカーA停止)
  └─ サブタスク2: blocked
  └─ サブタスク3: blocked
```

---

## 代替フロー

### A1. サブタスクがない場合

親タスクのみがブロック状態になる。エージェントが直接親タスクを実行中の場合、そのエージェントが停止対象となる。

### A2. 複数エージェントが実行中の場合

すべての実行中エージェントインスタンスが停止される。

---

## 事後条件

- 親タスクのステータスが `blocked` である
- すべてのサブタスクのステータスが `blocked` である
- 関連するエージェントインスタンスが停止している
- `get_agent_action` が `hold` を返す（再起動されない）

---

## 検証項目

| # | 検証内容 | 期待値 |
|---|----------|--------|
| 1 | 親タスクのステータス | blocked |
| 2 | サブタスクのステータス（カスケード） | すべて blocked |
| 3 | エージェントインスタンスの状態 | 停止 |
| 4 | get_agent_action の結果 | action: "stop" |

---

## 実装設計

### 処理フロー

```
[UI] 親タスク → blocked
        ↓
[TaskStore] サブタスクをカスケードでblocked
[TaskStore] 中断コンテキストを保存（進捗、状態など）
[MCPServer] 該当(agent_id, project_id)のセッションを無効化
        ↓
[Coordinator] 次回ポーリングで get_agent_action
        ↓
[MCPServer] action: "stop", reason: "task_blocked"
        ↓
[Coordinator] プロセス終了
```

### アプリ側（Swift）の実装

| コンポーネント | 作業内容 |
|----------------|----------|
| **TaskStore** | ステータス変更時にサブタスクをカスケードでblocked |
| **TaskStore** | blockedになったタスクのコンテキストを保存 |
| **MCPServer** | 該当セッションを無効化 |
| **MCPServer** | `get_agent_action`で`action: "stop"`を返す |

### Coordinator側（Python）の実装

| 作業内容 |
|----------|
| `action: "stop"` 受信時にプロセスを終了 |

### get_agent_action の拡張

```swift
// blockedタスクを検出した場合
if hasBlockedTask {
    return [
        "action": "stop",
        "reason": "task_blocked",
        "task_id": taskId
    ]
}
```

### ブロック解除時の挙動

- 別ユースケース（UC009）として検討

---

## 関連ユースケース

- UC001: エージェントによるタスク実行
- UC005: マネージャー・ワーカー委譲
- UC009: タスクのブロック解除（未定義）
