# 履歴・タイムライン画面

アプリに対するすべての入出力を時系列で閲覧する画面。
**監査チームと連携し、エージェント活動の透明性を担保する。**

---

## 画面概要

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📜 操作履歴                                        [🔍 検索]    ⚙️          │
├────────────┬────────────────────────────────────────────────────────────────┤
│            │                                                                │
│ 📁 Projects│  ┌────────────────────────────────────────────────────────────┐│
│   Project A│  │  フィルター                                                ││
│   Project B│  │  エージェント: [全員 ▼]  種別: [全て ▼]  期間: [今日 ▼]   ││
│            │  └────────────────────────────────────────────────────────────┘│
│ 👥 Agents  │                                                                │
│   owner    │  ┌────────────────────────────────────────────────────────────┐│
│   frontend │  │  📅 2024-12-30                                             ││
│            │  │  ────────────────────────────────────────────────────────  ││
│ 🛡️ Audit   │  │                                                            ││
│   Team A   │  │  14:30:25  🔄 タスク状態変更                               ││
│            │  │            🤖 backend-dev                                  ││
│ 📜 History │  │            📋 API実装: in_progress → done                  ││
│ ┌────────┐ │  │            📁 ECサイト開発                                 ││
│ │ ○ ◉ ○ │ │  │                                                            ││
│ │Timeline│ │  │  14:15:10  👤 タスク割り当て                               ││
│ └────────┘ │  │            🤖 owner                                        ││
│            │  │            📋 決済機能 → 🤖 backend-dev                    ││
│            │  │            📁 ECサイト開発                                 ││
│            │  │                                                            ││
│            │  │  13:45:00  📝 コンテキスト追加                             ││
│            │  │            🤖 frontend-dev                                 ││
│            │  │            📋 画面実装                                     ││
│            │  │            「レスポンシブ対応完了」                         ││
│            │  │                                                            ││
│            │  │  13:30:22  🔍 MCP閲覧操作                                  ││
│            │  │            🤖 backend-dev                                  ││
│            │  │            list_tasks (project: ECサイト開発)              ││
│            │  │                                                            ││
│            │  │  ────────────────────────────────────────────────────────  ││
│            │  │  📅 2024-12-29                                             ││
│            │  │  ────────────────────────────────────────────────────────  ││
│            │  │                                                            ││
│            │  │  18:00:00  ➕ タスク作成                                   ││
│            │  │            🤖 owner                                        ││
│            │  │            📋 認証機能 (新規)                              ││
│            │  │                                                            ││
│            │  └────────────────────────────────────────────────────────────┘│
│            │                                                                │
│            │  [さらに読み込む...]                                           │
│            │                                                                │
├────────────┴────────────────────────────────────────────────────────────────┤
│  1,234 events | Archive: 5,678 events | Last sync: Just now                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## イベント種別

| 種別 | アイコン | 説明 |
|------|---------|------|
| タスク状態変更 | 🔄 | backlog → todo → in_progress → done 等 |
| タスク割り当て | 👤 | エージェントへのアサイン・変更 |
| タスク作成 | ➕ | 新規タスク作成 |
| タスク編集 | ✏️ | タイトル・説明・優先度等の変更 |
| 依存関係設定 | 🔗 | タスク間依存関係の追加・削除 |
| コンテキスト追加 | 📝 | タスクへのコンテキスト情報追加 |
| ハンドオフ作成 | 🤝 | エージェント間引き継ぎ |
| MCP閲覧操作 | 🔍 | list_tasks, get_task_detail 等 |
| エージェント操作 | 🤖 | エージェント作成・編集・階層変更 |
| ロック操作 | 🔒 | タスクロック・エージェントロック |
| プロジェクト操作 | 📁 | プロジェクト作成・編集・アーカイブ |

---

## コンポーネント

### イベントカード

```
┌────────────────────────────────────────────────────────────────────┐
│  [時刻]  [イベント種別アイコン] [イベント種別名]                    │
│          [操作者アイコン] [操作者名]                               │
│          [対象情報]                                                │
│          [追加コンテキスト（あれば）]                               │
│          📁 [プロジェクト名]                        [詳細 ▶]      │
└────────────────────────────────────────────────────────────────────┘
```

### イベント詳細モーダル

```
┌────────────────────────────────────────────────────────────────┐
│  イベント詳細                                             [×]   │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  種別           🔄 タスク状態変更                              │
│  日時           2024-12-30 14:30:25                           │
│  操作者         🤖 backend-dev                                │
│                                                                │
│  ─── 対象 ───                                                 │
│                                                                │
│  タスク         📋 API実装                                     │
│  プロジェクト   📁 ECサイト開発                                │
│                                                                │
│  ─── 変更内容 ───                                             │
│                                                                │
│  変更前         🟢 in_progress                                 │
│  変更後         ✅ done                                        │
│                                                                │
│  ─── 関連情報 ───                                             │
│                                                                │
│  依存タスク     📋 DB設計 (done)                              │
│                 📋 認証設計 (done)                             │
│  後続タスク     📋 API統合 (blocked → todo)                   │
│                                                                │
│                                     [タスクを開く] [閉じる]    │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## フィルター

### フィルターバー

```
┌────────────────────────────────────────────────────────────────────┐
│ エージェント: [全員 ▼]  種別: [全て ▼]  期間: [今日 ▼]  [🔍検索] │
└────────────────────────────────────────────────────────────────────┘
```

| フィルター | オプション |
|-----------|-----------|
| エージェント | 全員 / 特定エージェント選択（複数可） |
| 種別 | 全て / 状態変更 / 割り当て / 作成・編集 / MCP操作 / ロック操作 |
| 期間 | 今日 / 昨日 / 過去7日 / 過去30日 / カスタム範囲 |
| プロジェクト | 全て / 特定プロジェクト選択 |
| タスク | 特定タスクのみ（検索から選択） |

### 詳細フィルター（展開時）

```
┌────────────────────────────────────────────────────────────────────┐
│ ▼ 詳細フィルター                                                   │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  エージェント                  イベント種別                         │
│  ┌──────────────────────┐     ┌──────────────────────┐            │
│  │ ☑ 🤖 backend-dev     │     │ ☑ 🔄 状態変更       │            │
│  │ ☑ 🤖 frontend-dev    │     │ ☑ 👤 割り当て       │            │
│  │ ☐ 🤖 owner           │     │ ☐ 🔍 MCP操作        │            │
│  └──────────────────────┘     │ ☑ 🔒 ロック操作     │            │
│                               └──────────────────────┘            │
│                                                                    │
│  期間                                                              │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │ 開始: [2024-12-01] ─ 終了: [2024-12-30]                     │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                    │
│                                        [リセット] [適用]           │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## MCP操作の表示

### 閲覧系操作

```
│  13:30:22  🔍 MCP閲覧操作                                          │
│            🤖 backend-dev                                          │
│            list_tasks                                              │
│            ├─ project: ECサイト開発                                │
│            └─ 結果: 12件                                          │
```

### 更新系操作

```
│  13:25:00  ✏️ MCP更新操作                                          │
│            🤖 backend-dev                                          │
│            update_task_status                                      │
│            ├─ task: API実装                                        │
│            └─ status: in_progress → done                          │
```

---

## 監査連携表示

### ロックイベント

```
│  15:00:00  🔒 タスクロック                                         │
│            🛡️ security-auditor (セキュリティ監査チーム)            │
│            📋 API実装                                              │
│            理由: セキュリティレビュー待ち                           │
```

### 監査警告表示

```
│  15:30:00  ⚠️ 監査警告                                             │
│            🛡️ security-auditor                                     │
│            📋 決済機能                                             │
│            警告: 作業記録なしに状態変更が行われました               │
```

---

## アーカイブ管理

### アーカイブステータス

```
┌────────────────────────────────────────────────────────────────────┐
│  📦 アーカイブ                                                      │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  現在の履歴        1,234 件 (過去30日)                             │
│  アーカイブ済み    5,678 件                                        │
│  最終アーカイブ    2024-12-01 00:00                                │
│                                                                    │
│  アーカイブポリシー: 30日経過した履歴を自動アーカイブ              │
│                                                                    │
│                    [アーカイブを閲覧] [設定変更]                   │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### アーカイブ閲覧モーダル

```
┌────────────────────────────────────────────────────────────────┐
│  📦 アーカイブ履歴                                        [×]   │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  期間: [2024-11 ▼]                                             │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ 📅 2024-11                                               │ │
│  │    イベント数: 2,345                                     │ │
│  │    サイズ: 1.2 MB                                        │ │
│  │                                          [展開して閲覧]  │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ 📅 2024-10                                               │ │
│  │    イベント数: 3,333                                     │ │
│  │    サイズ: 1.8 MB                                        │ │
│  │                                          [展開して閲覧]  │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│                                                    [閉じる]    │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## コンテキストメニュー

### イベント右クリック

```
┌─────────────────────────────┐
│ 📋 詳細を開く               │
├─────────────────────────────┤
│ 📌 関連タスクを開く         │
│ 👤 操作者の活動を表示       │
├─────────────────────────────┤
│ 🔍 類似イベントを検索       │
│ 📊 統計に追加               │
├─────────────────────────────┤
│ 📋 コピー                   │
└─────────────────────────────┘
```

---

## 状態管理

```swift
struct HistoryState {
    var events: [HistoryEvent]
    var filter: HistoryFilter
    var searchQuery: String
    var isLoading: Bool
    var hasMore: Bool
    var selectedEventId: EventID?
    var archiveInfo: ArchiveInfo
}

struct HistoryEvent {
    var id: EventID
    var timestamp: Date
    var eventType: EventType
    var actorId: AgentID
    var targetType: TargetType         // task / agent / project
    var targetId: String
    var projectId: ProjectID?
    var beforeState: String?           // JSON文字列
    var afterState: String?            // JSON文字列
    var context: String?               // 追加情報
}

enum EventType {
    case taskStatusChanged             // タスク状態変更
    case taskAssigned                  // タスク割り当て
    case taskCreated                   // タスク作成
    case taskUpdated                   // タスク編集
    case dependencyChanged             // 依存関係設定
    case contextAdded                  // コンテキスト追加
    case handoffCreated                // ハンドオフ作成
    case mcpRead                       // MCP閲覧操作
    case mcpWrite                      // MCP更新操作
    case agentOperation                // エージェント操作
    case lockOperation                 // ロック操作
    case projectOperation              // プロジェクト操作
    case auditWarning                  // 監査警告
}

enum TargetType {
    case task
    case agent
    case project
    case auditTeam
}

struct HistoryFilter {
    var agentIds: [AgentID]?           // nil = 全員
    var eventTypes: [EventType]?       // nil = 全て
    var projectId: ProjectID?          // nil = 全プロジェクト
    var taskId: TaskID?                // nil = 全タスク
    var dateRange: DateRange?          // nil = デフォルト期間
}

struct DateRange {
    var start: Date
    var end: Date
}

struct ArchiveInfo {
    var currentCount: Int              // 現在の履歴件数
    var archivedCount: Int             // アーカイブ済み件数
    var lastArchiveDate: Date?         // 最終アーカイブ日時
    var archivePolicy: ArchivePolicy   // アーカイブポリシー
}

struct ArchivePolicy {
    var retentionDays: Int             // 保持日数
    var autoArchive: Bool              // 自動アーカイブ有効
}
```

---

## キーボードショートカット

| ショートカット | アクション |
|---------------|-----------|
| ⌘ F | 検索フォーカス |
| ⌘ 5 | 履歴画面を開く |
| ↑ / ↓ | イベント間移動 |
| Enter | イベント詳細を開く |
| Esc | モーダルを閉じる / フィルターリセット |
| ⌘ R | 履歴を更新 |

---

## リアルタイム更新

### 新規イベント通知

```
┌──────────────────────────────────────────────────────────────┐
│  🔔 新しいイベントがあります (3件)            [表示] [無視]   │
└──────────────────────────────────────────────────────────────┘
```

### ライブモード

```
┌────────────────────────────────────────────────────────────────────┐
│  ⚡ ライブモード: ON                                    [一時停止] │
└────────────────────────────────────────────────────────────────────┘
```

ライブモードでは新規イベントが自動的にタイムラインの先頭に追加される。

---

## 統計ビュー（オプション）

### 日別サマリー

```
┌────────────────────────────────────────────────────────────────────┐
│  📊 今日の統計                                                      │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  総イベント数        156                                           │
│                                                                    │
│  種別別:                                                           │
│  ├─ 🔄 状態変更      45  ████████████░░░░░░░░  29%                │
│  ├─ 📝 コンテキスト  38  ██████████░░░░░░░░░░  24%                │
│  ├─ 🔍 MCP操作       52  █████████████░░░░░░░  33%                │
│  └─ その他           21  █████░░░░░░░░░░░░░░░  14%                │
│                                                                    │
│  アクティブエージェント: 4                                         │
│  最も活発: 🤖 backend-dev (67 events)                              │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025-01-01 | 1.0.0 | 初版作成 - 履歴・タイムライン画面 |
