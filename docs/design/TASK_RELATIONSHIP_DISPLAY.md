# タスク関係性表示設計

## 概要

Kanbanボード上でタスクの親子関係・依存関係を視認しやすく表示するための設計仕様。

## 設計原則

1. **シンプルさ優先**: カード上の情報は最小限に
2. **さりげない表現**: 深さは色で表現、インデントなし
3. **位置関係で暗示**: 同一カラム内は親→子の順でソート
4. **詳細は詳細パネルで**: 完全な情報は詳細パネルで確認

---

## 1. 親子関係の表示

### 1.1 カード上の表示

```
┌────────────────────────────────┐
│ タスクタイトル                 │
│ 📁親タスク名   🟡 Medium       │  ← 直接の親のみ表示
│ ⬆️2 ⬇️1              @worker   │
└────────────────────────────────┘
```

| 要素 | 説明 |
|------|------|
| 📁 | 親タスクへのリンクバッジ（クリックで親の詳細へ） |
| 親タスク名 | 直接の親のみ表示（祖先は表示しない） |

### 1.2 深さの色表現

カード左端に細いボーダー（3-4px）で深さを表現:

| 深さ | 色 | カラーコード | 説明 |
|------|-----|-------------|------|
| L0 | 青 | `#3B82F6` | ルートタスク（親なし） |
| L1 | 緑 | `#10B981` | 第1階層 |
| L2 | 黄 | `#F59E0B` | 第2階層 |
| L3 | オレンジ | `#F97316` | 第3階層 |
| L4+ | 赤 | `#EF4444` | 第4階層以深 |

### 1.3 同一カラム内のソート順

親子が同じステータス（同一カラム）にいる場合の表示順:

1. ルートタスク（親なし、L0）
2. その子タスク（L1）
3. その孫タスク（L2）
4. ...以下同様
5. 次のルートタスク

```
例: In Progress カラム内

▌認証機能 (L0)           ← 青
▌ログイン機能 (L1)       ← 緑
▌UI実装 (L2)             ← 黄
▌フォーム作成 (L3)       ← オレンジ
▌ログアウト機能 (L1)     ← 緑
▌DB設計 (L0)             ← 青（別ツリー）
▌テーブル設計 (L1)       ← 緑
```

### 1.4 親子が別カラムにいる場合

親がIn Progress、子がTodoの場合:

```
┌─ Todo ─────────────────────┐
│                            │
│ ▌┌──────────────────────┐  │
│ ▌│ ログアウト機能       │  │  ← L1の色（緑）
│ ▌│ 📁認証機能           │  │  ← 親へのリンク
│ ▌└──────────────────────┘  │
│                            │
└────────────────────────────┘
```

- 親バッジは表示
- 位置は通常のソート順（親子グループ化しない）
- 左ボーダー色で深さは認識可能

### 1.5 詳細パネルでの階層表示

```
┌─────────────────────────────────────────────────────┐
│ フォーム作成                                        │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 階層パス                                            │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 認証機能 > ログイン機能 > UI実装 > フォーム作成 │ │
│ │     ↑          ↑           ↑                   │ │
│ │   クリックで各タスクの詳細へ遷移                │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 子タスク (2件)                                      │
│ ┌─────────────────────────────────────────────────┐ │
│ │ • 入力フィールド実装          [In Progress]     │ │
│ │ • バリデーション実装          [Todo]            │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 2. 依存関係の表示

### 2.1 カード上のインジケーター

```
┌────────────────────────────────┐
│ タスクタイトル                 │
│ 📁親タスク    🟡 Medium        │
│ ⬆️2 ⬇️1              @worker   │
└────────────────────────────────┘
```

| 記号 | 意味 | 説明 |
|------|------|------|
| ⬆️n | 依存先 | このタスクが待っているタスク数 |
| ⬇️n | 依存元 | このタスクを待っているタスク数 |

- `⬆️0` の場合は非表示（依存なし）
- `⬇️0` の場合は非表示（他タスクをブロックしていない）
- ホバーでツールチップ表示（タスク名一覧）

### 2.2 Blockedカラムでの理由表示

```
┌────────────────────────────────┐
│ フロントエンド実装             │
│ ─────────────────────────────  │
│ ⛔ Blocked by:                 │
│   • 認証機能実装 (in_progress) │  ← クリックで該当タスクへ
│   • API設計 (todo)             │
└────────────────────────────────┘
```

- Blockedステータスのタスクのみ
- 未完了の依存先タスクを一覧表示
- 各タスクはクリックで詳細へ遷移

### 2.3 詳細パネルでの依存関係表示

```
┌─────────────────────────────────────────────────────┐
│ タスク詳細                                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 依存先 (このタスクが待っているタスク)              │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 🔴 認証機能実装              [In Progress]      │ │
│ │ ✅ DB設計完了                [Done]             │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 依存元 (このタスクを待っているタスク)              │
│ ┌─────────────────────────────────────────────────┐ │
│ │ ⏸️ E2Eテスト                 [Blocked]          │ │
│ │ ⏸️ デプロイ準備              [Backlog]          │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
└─────────────────────────────────────────────────────┘
```

| アイコン | 意味 |
|----------|------|
| ✅ | 完了（Done） |
| 🔴 | 未完了で進行中（In Progress） |
| ⏸️ | 待機中（Blocked/Backlog/Todo） |

---

## 3. Web UI型定義の変更

### 3.1 Task インターフェース

```typescript
// web-ui/src/types/task.ts

export interface Task {
  id: string
  projectId: string
  title: string
  description: string
  status: TaskStatus
  priority: TaskPriority
  assigneeId: string | null
  creatorId: string

  // 親子関係
  parentTaskId: string | null       // 追加: 親タスクID

  // 依存関係
  dependencies: string[]            // 既存: 依存先タスクID
  dependentTasks: string[]          // 追加: 依存元タスクID（逆依存）

  // ブロック情報
  blockedReason: string | null      // 追加: ブロック理由

  // 時間管理
  estimatedMinutes: number | null   // 追加: 見積もり時間
  actualMinutes: number | null      // 追加: 実績時間

  // 承認関連（既存）
  approvalStatus: ApprovalStatus
  requesterId: string | null
  rejectedReason: string | null

  // 日時（既存）
  createdAt: string
  updatedAt: string
}
```

### 3.2 表示用ヘルパー型

```typescript
// web-ui/src/types/task.ts

// タスクの深さ情報
export interface TaskDepthInfo {
  level: number           // 0 = ルート, 1 = 第1階層, ...
  parentTitle: string | null
  ancestorPath: string[]  // ['認証機能', 'ログイン機能', 'UI実装']
}

// 依存関係の表示情報
export interface DependencyDisplayInfo {
  id: string
  title: string
  status: TaskStatus
}
```

---

## 4. コンポーネント変更

### 4.1 TaskCard

```typescript
interface TaskCardProps {
  task: Task
  depth: TaskDepthInfo           // 追加
  parentTask?: Task              // 追加: 親タスク情報
  dependencyCount: {             // 追加
    upstream: number    // 依存先数
    downstream: number  // 依存元数
  }
}
```

**表示要素**:
- 左ボーダー: `depth.level` に応じた色
- 親バッジ: `parentTask?.title` があれば表示
- 依存インジケーター: `dependencyCount` を表示

### 4.2 KanbanColumn

**ソートロジック追加**:
```typescript
function sortTasksWithHierarchy(tasks: Task[]): Task[] {
  // 1. ルートタスクを抽出
  // 2. 各ルートの子孫を深さ優先で配置
  // 3. ルートタスク間は優先度順
}
```

### 4.3 TaskDetailPanel

**追加セクション**:
- 階層パス（パンくずナビゲーション）
- 子タスク一覧
- 依存先タスク一覧（ステータス付き）
- 依存元タスク一覧（ステータス付き）

---

## 5. 実装優先度

| 優先度 | 内容 | 工数 |
|--------|------|------|
| P0 | Web UI型定義の同期 | 小 |
| P1 | TaskCardに依存数インジケーター追加 | 小 |
| P1 | TaskCardに左ボーダー（深さ色）追加 | 小 |
| P1 | TaskCardに親バッジ追加 | 小 |
| P1 | Blockedカラムで理由表示 | 小 |
| P2 | 同一カラム内の親子ソート | 中 |
| P2 | TaskDetailPanelの階層パス表示 | 中 |
| P2 | TaskDetailPanelの依存関係セクション強化 | 中 |
| P3 | ホバーツールチップ（依存タスク名一覧） | 小 |

---

## 6. 将来拡張

### 6.1 依存関係グラフビュー

タブ切り替えで Kanban ⇄ Graph 表示:
- ライブラリ: `react-flow` または `dagre` + `d3`
- タスク間の依存関係を矢印で可視化

### 6.2 フィルター機能

- 特定の親タスク配下のみ表示
- 特定タスクの依存チェーンのみ表示
- ブロック中タスクのみ表示

### 6.3 一括操作

- 親タスクのステータス変更で子も連動
- 依存関係の一括設定

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-25 | 初版作成 |
