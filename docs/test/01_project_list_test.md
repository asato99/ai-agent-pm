# プロジェクト一覧画面 テストシナリオ

**対応UI仕様**: `docs/ui/01_project_list.md`
**テストクラス**: `ProjectListTests`
**最終更新**: 2024-12-31

---

## 進捗サマリ

| 状態 | 件数 |
|------|------|
| ✅ 実装済み | 5 |
| 🔸 スタブ | 0 |
| ⏳ 未実装 | 4 |

---

## 画面概要

プロジェクトの選択・作成・管理を行うサイドバー画面。3カラムレイアウトの左端に配置。

```
┌────────────┬─────────────────────────────────────┐
│ 📁 Projects│  プロジェクト一覧                    │
│ ┌────────┐ │  ┌─────────────────────────────┐    │
│ │Project │ │  │ 📁 ECサイト開発      ⚡ Active│    │
│ │   A    │ │  │    タスク: 12 | 完了: 5       │    │
│ └────────┘ │  └─────────────────────────────┘    │
│ 👥 Agents  │                                      │
│ 🛡️ Audit   │                                      │
│ 📜 History │                                      │
└────────────┴─────────────────────────────────────┘
```

※ エージェントはトップレベル管理（プロジェクト横断）

---

## テストシナリオ

### TS-01-001: サイドバー存在確認

**目的**: アプリ起動時にプロジェクトサイドバーが表示されること

**前提条件**:
- アプリが起動している

**手順**:
1. アプリを起動する
2. メインウィンドウを確認する

**期待結果**:
- メインウィンドウが表示される
- サイドバー領域が存在する
- 「Projects」セクションが表示される

**PRD参照**: 画面概要

**実装状態**: 🔸 スタブ
**現状**: `assertWindowExists()` のみ。「Projects」テキストの存在確認が必要。
**テストメソッド**: `testProjectListSidebarExists()`

---

### TS-01-002: ツールバーボタン存在確認

**目的**: ツールバーに必要なボタンが配置されていること

**前提条件**:
- アプリが起動している

**手順**:
1. ツールバー領域を確認する
2. 各ボタンの存在を確認する

**期待結果**:
- ツールバーが表示される
- 新規作成ボタン（+）が存在する
- 設定ボタン（⚙️）が存在する

**PRD参照**:
```
│  AI Agent PM                    [+] New    ⚙️  │
```

**実装状態**: 🔸 スタブ
**現状**: ツールバー存在またはボタン数>0のみ確認。具体的なボタン（+、設定）の検証なし。
**テストメソッド**: `testToolbarButtonsExist()`

---

### TS-01-003: 新規プロジェクト作成シート表示

**目的**: 「+」ボタンをタップすると新規プロジェクト作成シートが表示されること

**前提条件**:
- アプリが起動している
- 新規作成ボタンが存在する

**手順**:
1. 「+」または「New」ボタンを探す
2. ボタンをタップする
3. シートの表示を確認する

**期待結果**:
- シートがモーダル表示される
- シートに以下の要素が含まれる:
  - 「新規プロジェクト」タイトル
  - プロジェクト名入力フィールド
  - 説明入力フィールド
  - 「キャンセル」ボタン
  - 「作成」ボタン

**PRD参照**: 新規プロジェクト作成セクション

**実装状態**: 🔸 スタブ
**現状**: ボタン検索とタップ試行はあるが、シート表示の検証なし。最終的に `assertWindowExists()` のみ。
**テストメソッド**: `testNewProjectButtonOpensSheet()`

---

### TS-01-004: 空状態表示

**目的**: プロジェクトがない場合に適切な空状態が表示されること

**前提条件**:
- アプリが起動している
- プロジェクトが0件

**手順**:
1. プロジェクト一覧を確認する

**期待結果**:
- 空状態メッセージが表示される
- 「プロジェクトがありません」または同等のメッセージ
- 新規作成を促すボタンが表示される

**PRD参照**: 空状態セクション
```
│           プロジェクトがありません                 │
│     最初のプロジェクトを作成して                   │
│     AIエージェントとの協働を始めましょう           │
│              [+ 新規プロジェクト作成]              │
```

**実装状態**: 🔸 スタブ
**現状**: `assertWindowExists()` のみ。空状態メッセージの検証なし。
**テストメソッド**: `testEmptyStateWhenNoProjects()`

---

### TS-01-005: プロジェクト選択によるコンテンツ変更

**目的**: プロジェクトを選択すると中央カラムにタスクボードが表示されること

**前提条件**:
- アプリが起動している
- 少なくとも1つのプロジェクトが存在する

**手順**:
1. サイドバーのプロジェクトリストを確認する
2. プロジェクトをクリックして選択する
3. 中央カラムの変化を確認する

**期待結果**:
- 選択したプロジェクトがハイライトされる
- 中央カラムにタスクボードが表示される
- プロジェクト名がヘッダーに表示される

**PRD参照**: プロジェクト選択

**実装状態**: 🔸 スタブ
**現状**: `assertWindowExists()` のみ。プロジェクト選択と画面遷移の検証なし。
**テストメソッド**: `testProjectSelectionChangesContent()`

---

### TS-01-006: プロジェクトカード情報表示

**目的**: プロジェクトカードに正しい情報が表示されること

**期待結果**:
- プロジェクト名
- ステータスバッジ（Active/Archived）
- タスクサマリ（総数/完了/進行中/ブロック）
- 割当エージェント数
- 最終更新時刻・イベント

**PRD参照**: プロジェクトカード

**実装状態**: ⏳ 未実装
**テストメソッド**: なし

---

### TS-01-007: コンテキストメニュー表示

**目的**: プロジェクトを右クリックするとコンテキストメニューが表示されること

**期待結果**:
- タスクボードを開く
- プロジェクト編集
- 統計を見る
- アーカイブ
- 削除

**PRD参照**: コンテキストメニュー

**実装状態**: ⏳ 未実装
**テストメソッド**: なし

---

### TS-01-008: ソートオプション

**目的**: プロジェクト一覧をソートできること

**期待結果**:
- 最近更新順（デフォルト）
- 名前順
- 作成日順
- タスク数順

**PRD参照**: プロジェクト一覧のソート

**実装状態**: ⏳ 未実装
**テストメソッド**: なし

---

### TS-01-009: フィルターオプション

**目的**: プロジェクト一覧をフィルタリングできること

**期待結果**:
- すべて
- アクティブ
- アーカイブ済み

**PRD参照**: フィルター

**実装状態**: ⏳ 未実装
**テストメソッド**: なし

---

## ステータスバッジ仕様

| ステータス | 表示 | 条件 |
|-----------|------|------|
| Active | ⚡ Active (青) | 有効なプロジェクト |
| Archived | 📦 Archived (グレー) | アーカイブ済み |

※ プロジェクトステータスは `active` / `archived` のみ（要件: PROJECTS.md）

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2024-12-31 | 初版作成（実装状況を「✅実装済み」と誤記） |
| 2024-12-31 | 実装状況を正確に修正（全て🔸スタブまたは⏳未実装） |
| 2024-12-31 | UIテストセットアップ/ティアダウン実装、アクセシビリティ識別子対応開始 |
| 2024-12-31 | UIテスト基盤改善: SQLite journal cleanup, NotificationCenter連携, XCUITest制限事項文書化 |
| 2025-01-01 | 要件再整理: サイドバー構成変更、ステータスをActive/Archivedに簡素化 |

---

## 実装メモ

### UIテスト基盤（2024-12-31）

**完了:**
- ✅ TestDataSeeder実装（Empty/Basic/MultiProjectシナリオ対応）
- ✅ UIテスト用DB分離（`-UITesting`フラグ）
- ✅ シナリオ選択（`-UITestScenario:XXX`引数）
- ✅ UIにアクセシビリティ識別子を追加完了
  - `ProjectListView`: `ProjectList`, `NewProjectButton`, `CreateFirstProjectButton`, `EmptyState`, `ProjectRow_*`
  - `TaskBoardView`: `TaskBoard`, `TaskColumn_*`, `TaskCard_*`, `NewTaskButton`, `RefreshButton`
  - `TaskDetailView`: `TaskDetailView`, `TaskHeader`, `TaskTitle`, `TaskStatus`, `TaskPriority`, `SubtasksSection`, `ContextSection`, `EditTaskButton`, `HandoffButton`
  - `AgentDetailView`: `AgentDetailView`, `EditAgentButton`
- ✅ UITests更新完了（実際のUI構造に合わせて修正）
  - 未実装機能は `XCTSkip` でスキップ
  - ヘルパーメソッド追加（`selectProject()`, `openTaskDetail()`）

**テスト実行結果:**
- ビルド: ✅ 成功
- 実行: GUI環境が必要（Terminal/CI環境では実行不可）

**未実装UI機能（XCTSkipでスキップ）:**
- エージェント管理画面（サイドバーのAgentsセクション）
- ドラッグ&ドロップ
- コンテキストメニュー
- 検索・フィルター機能
- タブ形式のタスク詳細（現在はスクロールビュー形式）
- 履歴タブ、ハンドオフ一覧、依存関係表示

---

### UIテスト基盤改善（2024-12-31 第2次更新）

**問題1: SQLite disk I/O error**
- 原因: 前回テスト実行時のジャーナルファイル（-shm, -wal）が残存
- 解決: `AIAgentPMApp.swift` でジャーナルファイルも削除するよう修正
```swift
try? FileManager.default.removeItem(atPath: testDBPath + "-shm")
try? FileManager.default.removeItem(atPath: testDBPath + "-wal")
```

**問題2: データシード完了前にUIがロード**
- 原因: async seeding と UI loading の競合
- 解決: NotificationCenter による同期
```swift
// AIAgentPMApp.swift
NotificationCenter.default.post(name: .testDataSeeded, object: nil)

// ProjectListView.swift
.onReceive(NotificationCenter.default.publisher(for: .testDataSeeded)) { _ in
    await loadProjects()
}
```

**問題3: XCUITest がウィンドウを検出できない**
- 症状: `app.windows.count == 0`、全UI要素が未検出
- 原因: ターミナル環境では WindowServer への接続がない
- 結論: **Xcode GUI から実行が必須**
- 詳細: `docs/test/README.md` の「macOS XCUITest 制限事項」参照

**追加した機能:**
- `AppDelegate` による明示的なウィンドウ管理
- `-UITesting` 引数検出時の `NSApplication.shared.activate()`
- テストデータシード完了通知システム
